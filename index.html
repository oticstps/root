<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Data Produksi</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-bg: #f8f9fa;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --text-color: #212529;
            --text-muted: #6c757d;
        }
        .dark-mode {
            --primary-color: #3a86ff;
            --secondary-color: #adb5bd;
            --success-color: #06d6a0;
            --danger-color: #ef476f;
            --warning-color: #ffd166;
            --light-bg: #121212;
            --card-bg: #1e1e1e;
            --border-color: #333;
            --text-color: #e0e0e0;
            --text-muted: #adb5bd;
            --table-header-bg: #2d2d2d;
            --table-row-even: #252525;
            --shift-separator: #333;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--light-bg);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
        }
        /* Page Containers */
        .page {
            display: none;
            flex-direction: column;
            height: 100vh;
            width: 100%;
        }
        .page.active {
            display: flex;
        }
        /* Login Page */
        .login-container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
            margin: auto;
        }
        .login-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
        }
        .app-logo {
            text-align: center;
            margin-bottom: 25px;
        }
        .app-logo i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        .app-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 5px;
        }
        .app-subtitle {
            font-size: 0.95rem;
            color: var(--text-muted);
        }
        .form-label {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: var(--text-color);
        }
        .form-control, .form-select {
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
            color: var(--text-color);
        }
        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-weight: 500;
            font-size: 1rem;
            margin-top: 10px;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0b5ed7;
        }
        .status-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .alert-danger {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(220, 53, 69, 0.2);
        }
        .footer-text {
            text-align: center;
            margin-top: 20px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        /* App Header */
        .app-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .app-header-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .user-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .logout-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }
        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        /* Form Container */
        .form-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        /* Data Card */
        .data-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }
        .data-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .data-title {
            font-weight: 600;
            color: var(--primary-color);
        }
        .data-date {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .data-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .data-label {
            color: var(--text-muted);
        }
        .data-value {
            font-weight: 500;
            color: var(--text-color);
        }
        /* Filter Section */
        .filter-section {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        .month-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .month-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
        }
        .month-display {
            flex: 1;
            text-align: center;
            font-weight: 500;
            font-size: 1.1rem;
            color: var(--text-color);
        }
        .no-data {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
        }
        .no-data i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        /* User Profile */
        .profile-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            text-align: center;
        }
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            margin: 0 auto 15px;
        }
        .profile-name {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-color);
        }
        .profile-email {
            color: var(--text-muted);
            margin-bottom: 20px;
        }
        .profile-info {
            text-align: left;
            margin-top: 20px;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .info-label {
            color: var(--text-muted);
        }
        .info-value {
            font-weight: 500;
            color: var(--text-color);
        }
        /* Bottom Navigation */
        .bottom-nav {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid var(--border-color);
            z-index: 1000;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-muted);
            font-size: 0.75rem;
            transition: color 0.2s;
        }
        .nav-item.active {
            color: var(--primary-color);
        }
        .nav-item i {
            font-size: 1.25rem;
            margin-bottom: 4px;
        }
        /* Shift Info */
        .shift-info {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 5px;
            padding: 8px 12px;
            background-color: rgba(13, 110, 253, 0.05);
            border-radius: 6px;
            border-left: 3px solid var(--primary-color);
        }
        /* Loading Spinner */
        .spinner-border {
            width: 1rem;
            height: 1rem;
            border-width: 0.15em;
        }
        .d-none {
            display: none;
        }
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-edit {
            background-color: var(--warning-color);
            border: none;
            color: #000;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
        }
        .btn-delete {
            background-color: var(--danger-color);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
        }
        /* Modal */
        .modal-content {
            border-radius: 12px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        .modal-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        .modal-footer {
            padding: 10px 15px;
            border-top: 1px solid var(--border-color);
        }
        /* Dashboard Styles */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .dashboard-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color);
        }
        .dashboard-date-range {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .summary-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            text-align: center;
        }
        .summary-card-title {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }
        .summary-card-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        .line-monitoring-section {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }
        .line-monitoring-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        .line-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            min-width: 600px;
        }
        .line-table th,
        .line-table td {
            padding: 8px 6px;
            text-align: center;
            border: 1px solid var(--border-color);
            white-space: nowrap;
        }
        .line-table th {
            background-color: var(--table-header-bg);
            font-weight: 600;
            position: sticky;
            top: 0;
            color: var(--text-color);
        }
        .line-table td {
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        .line-table tr:nth-child(even) td {
            background-color: var(--table-row-even);
        }
        /* Custom Alert Styles */
        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .custom-alert-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .custom-alert {
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            transform: translateY(-50px);
            transition: transform 0.3s ease;
            color: var(--text-color);
        }
        .custom-alert-overlay.show .custom-alert {
            transform: translateY(0);
        }
        .custom-alert-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .custom-alert-title {
            font-weight: bold;
            font-size: 1.1rem;
        }
        .custom-alert-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }
        .custom-alert-body {
            padding: 20px;
        }
        .custom-alert-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .custom-alert-btn {
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
        .custom-alert-btn-confirm {
            background-color: var(--primary-color);
            color: white;
        }
        .custom-alert-btn-cancel {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        /* Shift separation styles */
        .shift-separator {
            background-color: var(--shift-separator) !important;
            font-weight: bold;
        }
        /* Filter Section Styling */
        .filter-section .form-label {
            font-size: 0.75rem;
            margin-bottom: 3px;
            color: var(--text-muted);
        }
        .filter-section .form-select {
            padding: 5px 10px;
            font-size: 0.85rem;
        }
        .filter-section .btn {
            padding: 5px 10px;
            font-size: 0.85rem;
        }
        /* Access Control */
        .access-control-section {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        .access-control-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .access-control-item:last-child {
            border-bottom: none;
        }
        .access-control-label {
            font-weight: 500;
            color: var(--text-color);
        }
        .access-control-value {
            color: var(--text-muted);
        }
        /* Settings Section */
        .settings-section {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .settings-item:last-child {
            border-bottom: none;
        }
        .settings-label {
            font-weight: 500;
            color: var(--text-color);
        }
        .settings-value {
            color: var(--text-muted);
        }
        /* Auto Logout Warning */
        .auto-logout-warning {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1500;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 90%;
            width: 350px;
        }
        .auto-logout-warning.hidden {
            display: none;
        }
        .auto-logout-timer {
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }
        .auto-logout-buttons {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }
        .auto-logout-btn {
            padding: 5px 10px;
            border-radius: 4px;
            border: none;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .auto-logout-stay {
            background-color: var(--primary-color);
            color: white;
        }
        .auto-logout-logout {
            background-color: var(--danger-color);
            color: white;
        }
        /* Refresh Loading Popup */
        #refreshLoadingPopup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2500;
        }
        #refreshLoadingPopup.show {
            display: flex;
        }
        .refresh-loading-content {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            color: var(--text-color);
        }
        /* Line Access Selection */
        .line-access-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .line-access-item {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            background-color: var(--table-row-even);
            border-radius: 5px;
            font-size: 0.85rem;
        }
        .line-access-item .form-check {
            margin-bottom: 0;
        }
        .line-access-item .form-check-input {
            margin-top: 0;
            margin-right: 5px;
        }
        /* Form Switch Dark Mode */
        .form-switch .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        /* Button Styles */
        .btn-outline-secondary {
            border-color: var(--border-color);
            color: var(--text-color);
        }
        .btn-outline-secondary:hover {
            background-color: var(--table-row-even);
        }
        /* Table Header Sub-headers */
        .line-table th[colspan="2"] {
            background-color: var(--table-header-bg);
        }
        /* Responsive adjustments */
        @media (max-width: 576px) {
            .line-table {
                font-size: 0.75rem;
            }
            .line-table th,
            .line-table td {
                padding: 6px 4px;
            }
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        /* KPP Specific Styles */
        .kpp-ng-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            background-color: var(--card-bg);
            margin-top: 5px;
        }
        .kpp-ng-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }
        .kpp-ng-item:hover {
            background-color: var(--primary-color);
            color: white;
        }
        .kpp-ng-item:last-child {
            border-bottom: none;
        }
        /* Settings Management Section */
        .management-section {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        .management-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .management-item:last-child {
            border-bottom: none;
        }
        .management-label {
            font-weight: 500;
            color: var(--text-color);
        }
        .management-buttons {
            display: flex;
            gap: 10px;
        }
        .btn-management {
            padding: 5px 10px;
            font-size: 0.85rem;
        }
        /* Management Modal Styles */
        .management-modal-content {
            border-radius: 12px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        .management-modal-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        .management-modal-body {
            padding: 20px;
        }
        .management-modal-footer {
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }
        .management-form-group {
            margin-bottom: 15px;
        }
        .management-form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .management-form-input, .management-form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        .management-form-input:focus, .management-form-select:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        .management-error {
            color: var(--danger-color);
            font-size: 0.85rem;
            margin-top: 5px;
        }
        .management-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            background-color: var(--card-bg);
            margin-top: 10px;
        }
        .management-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .management-list-item:last-child {
            border-bottom: none;
        }
        .management-item-info {
            flex: 1;
        }
        .management-item-actions {
            display: flex;
            gap: 5px;
        }
        .management-item-name {
            font-weight: 500;
        }
        .management-item-details {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <!-- Refresh Loading Popup -->
    <div id="refreshLoadingPopup" class="show">
        <div class="refresh-loading-content">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem; margin-bottom: 15px;">
                <span class="visually-hidden">Memuat...</span>
            </div>
            <div style="font-size: 1.1rem; font-weight: 500;">Memuat Data...</div>
        </div>
    </div>
    <!-- Login Page -->
    <div id="loginPage" class="page active">
        <div class="login-container">
            <div class="login-card">
                <div class="app-logo">
                    <img src="assets/otics.png" alt="Logo" style="width: 100px; height: 100px;" />
                    <h1 class="app-title">KANRIBAN PRODUKSI</h1>
                    <p class="app-subtitle">Silakan login untuk melanjutkan</p>
                </div>
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="email" class="form-label">Username</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" id="loginBtn">
                        <span id="loginText">Login</span>
                        <span id="loginSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                </form>
                <div id="loginStatus" class="status-message mt-3 d-none"></div>
                <div class="footer-text">
                    © 2025 Data Produksi | v1.0
                </div>
            </div>
        </div>
    </div>
    <!-- Home Page -->
    <div id="homePage" class="page">
        <!-- App Header -->
        <header class="app-header">
            <div class="app-header-title">Otics Dashboard Produksi</div>
            <div class="user-section">
                <div class="user-avatar" id="homeUserAvatar">U</div>
                <button class="logout-btn" id="homeLogoutBtn">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
            </div>
        </header>
        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div class="dashboard-title">Ringkasan Produksi</div>
                <div class="dashboard-date-range" id="dashboardDateRange">1 - 31 Januari 2023</div>
            </div>
            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-card-title">Total Produksi</div>
                    <div class="summary-card-value" id="totalProduction">0</div>
                    <div class="summary-card-title">pcs</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-title">Total Loading Time</div>
                    <div class="summary-card-value" id="totalLoadingTime">0</div>
                    <div class="summary-card-title">menit</div>
                </div>
            </div>
            <!-- Filter Section -->
            <section class="filter-section">
                <h2 class="section-title">Filter Data</h2>
                <div class="month-selector">
                    <button class="month-btn" id="prevMonth">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <div class="month-display" id="currentMonth">Januari 2023</div>
                    <button class="month-btn" id="nextMonth">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </section>
            <!-- Line Monitoring Section -->
            <section class="line-monitoring-section">
                <h2 class="line-monitoring-title">Monitoring Line Produksi</h2>
                <div style="overflow-x: auto;">
                    <table class="line-table">
                        <thead id="tableHeader">
                            <!-- Header will be generated dynamically -->
                        </thead>
                        <tbody id="lineTableBody">
                            <!-- Data rows will be generated dynamically -->
                        </tbody>
                    </table>
                </div>
            </section>
            <!-- Data List Section -->
            <section class="data-section">
                <h2 class="section-title">Data Produksi Terbaru</h2>
                <!-- Filter Section untuk Data Terbaru -->
                <div class="filter-section mb-3">
                    <div class="row g-2">
                        <div class="col-6 col-md-3">
                            <label for="filterLine" class="form-label">Line Produksi</label>
                            <select class="form-select form-select-sm" id="filterLine">
                                <option value="">Semua Line</option>
                                <!-- Options akan diisi secara dinamis dari Firestore -->
                            </select>
                        </div>
                        <div class="col-6 col-md-3">
                            <label for="filterPart" class="form-label">Part</label>
                            <select class="form-select form-select-sm" id="filterPart">
                                <option value="">Semua Part</option>
                                <!-- Options akan diisi secara dinamis berdasarkan line yang dipilih -->
                            </select>
                        </div>
                        <div class="col-6 col-md-2">
                            <label for="filterGroup" class="form-label">Group</label>
                            <select class="form-select form-select-sm" id="filterGroup">
                                <option value="">Semua Group</option>
                                <option value="PG-1">PG-1</option>
                                <option value="PG-2.1">PG-2.1</option>
                                <option value="PG-2.2">PG-2.2</option>
                                <option value="PG-2.3">PG-2.3</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-2">
                            <label for="filterShift" class="form-label">Shift</label>
                            <select class="form-select form-select-sm" id="filterShift">
                                <option value="">Semua Shift</option>
                                <option value="1">Shift 1</option>
                                <option value="2">Shift 2</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-2 d-flex align-items-end">
                            <button class="btn btn-outline-secondary w-100" id="resetFilterBtn">
                                <i class="bi bi-x-circle"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>
                <div id="dataContainer">
                    <div class="no-data" id="noDataMessage">
                        <i class="bi bi-clipboard-data"></i>
                        <p>Tidak ada data produksi</p>
                        <small>Silakan input data terlebih dahulu</small>
                    </div>
                </div>
            </section>
        </main>
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="#" class="nav-item active" id="homeNav">
                <i class="bi bi-house"></i>
                <span>Home</span>
            </a>
            <a href="#" class="nav-item" id="inputNav">
                <i class="bi bi-plus-circle"></i>
                <span>Input</span>
            </a>
            <a href="#" class="nav-item" id="kppNav">
                <i class="bi bi-exclamation-triangle"></i>
                <span>KPP</span>
            </a>
            <a href="#" class="nav-item" id="profileNav">
                <i class="bi bi-person"></i>
                <span>Profil</span>
            </a>
            <a href="#" class="nav-item" id="settingsNav">
                <i class="bi bi-gear"></i>
                <span>Settings</span>
            </a>
        </nav>
    </div>
    <!-- Input/Edit Page -->
    <div id="inputPage" class="page">
        <!-- App Header -->
        <header class="app-header">
            <div class="app-header-title" id="inputPageTitle">Input Data</div>
            <div class="user-section">
                <div class="user-avatar" id="inputUserAvatar">U</div>
                <button class="logout-btn" id="inputLogoutBtn">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
            </div>
        </header>
        <!-- Main Content -->
        <main class="main-content">
            <section class="input-section">
                <h2 class="section-title" id="formTitle">Input Data Produksi</h2>
                <div class="form-container">
                    <form id="productionForm">
                        <input type="hidden" id="documentId">
                        <div class="mb-3">
                            <label for="namaLineProduksi" class="form-label">Nama Line Produksi</label>
                            <select class="form-select" id="namaLineProduksi" required>
                                <option value="" selected disabled>Pilih Line Produksi</option>
                                <!-- Options akan diisi secara dinamis dari Firestore -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="namaPart" class="form-label">Nama Part</label>
                            <select class="form-select" id="namaPart" required disabled>
                                <option value="" selected disabled>Pilih Line Produksi Terlebih Dahulu</option>
                                <!-- Options akan diisi secara dinamis berdasarkan line yang dipilih -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="tanggal" class="form-label">Tanggal</label>
                            <input type="date" class="form-control" id="tanggal" required>
                        </div>
                        <div class="mb-3">
                            <label for="group" class="form-label">Group</label>
                            <select class="form-select" id="group" required>
                                <option value="" selected disabled>Pilih Group</option>
                                <option value="PG-1">PG-1</option>
                                <option value="PG-2.1">PG-2.1</option>
                                <option value="PG-2.2">PG-2.2</option>
                                <option value="PG-2.3">PG-2.3</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="shift" class="form-label">Shift</label>
                            <select class="form-select" id="shift" required>
                                <option value="" selected disabled>Pilih Shift</option>
                                <option value="1">Shift 1</option>
                                <option value="2">Shift 2</option>
                            </select>
                            <div id="shiftInfo" class="shift-info mt-2 d-none"></div>
                        </div>
                        <div class="mb-3">
                            <label for="sigmaProduksi" class="form-label">Total Produksi</label>
                            <input type="number" step="any" class="form-control" id="sigmaProduksi" required>
                        </div>
                        <div class="mb-3">
                            <label for="sigmaOP" class="form-label">Total OP</label>
                            <input type="number" step="any" class="form-control" id="sigmaOP" required>
                        </div>
                        <div class="mb-3">
                            <label for="loadingTime" class="form-label">Loading Time (menit)</label>
                            <input type="number" step="any" class="form-control" id="loadingTime" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" id="submitBtn">
                            <span id="submitText">Simpan Data</span>
                            <span id="submitSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                    </form>
                    <div id="inputStatusMessage" class="status-message mt-3 d-none"></div>
                </div>
            </section>
        </main>
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="#" class="nav-item" id="homeNav2">
                <i class="bi bi-house"></i>
                <span>Home</span>
            </a>
            <a href="#" class="nav-item active" id="inputNav2">
                <i class="bi bi-plus-circle"></i>
                <span>Input</span>
            </a>
            <a href="#" class="nav-item" id="kppNav2">
                <i class="bi bi-exclamation-triangle"></i>
                <span>KPP</span>
            </a>
            <a href="#" class="nav-item" id="profileNav2">
                <i class="bi bi-person"></i>
                <span>Profil</span>
            </a>
            <a href="#" class="nav-item" id="settingsNav2">
                <i class="bi bi-gear"></i>
                <span>Settings</span>
            </a>
        </nav>
    </div>
    <!-- KPP Input Page -->
    <div id="kppInputPage" class="page">
        <!-- App Header -->
        <header class="app-header">
            <div class="app-header-title">Input Data KPP (NG)</div>
            <div class="user-section">
                <div class="user-avatar" id="kppUserAvatar">U</div>
                <button class="logout-btn" id="kppLogoutBtn">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
            </div>
        </header>
        <!-- Main Content -->
        <main class="main-content">
            <section class="input-section">
                <h2 class="section-title">Input Data NG Part</h2>
                <div class="form-container">
                    <form id="kppForm">
                        <input type="hidden" id="kppDocumentId">
                        <div class="mb-3">
                            <label for="kppLineProduksi" class="form-label">Line Produksi</label>
                            <select class="form-select" id="kppLineProduksi" required>
                                <option value="" selected disabled>Pilih Line Produksi</option>
                                <!-- Options akan diisi secara dinamis dari Firestore -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="kppPart" class="form-label">Nama Part</label>
                            <select class="form-select" id="kppPart" required disabled>
                                <option value="" selected disabled>Pilih Line Produksi Terlebih Dahulu</option>
                                <!-- Options akan diisi secara dinamis -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="kppProses" class="form-label">Proses</label>
                            <select class="form-select" id="kppProses" required disabled>
                                <option value="" selected disabled>Pilih Part Terlebih Dahulu</option>
                                <!-- Options akan diisi secara dinamis -->
                            </select>
                            <!-- Dropdown NG Items akan muncul di sini -->
                            <div id="kppNgDropdown" class="kpp-ng-list d-none">
                                <!-- NG items akan diisi secara dinamis -->
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="kppItemNG" class="form-label">Item NG</label>
                            <input type="text" class="form-control" id="kppItemNG" readonly required placeholder="Pilih proses terlebih dahulu">
                        </div>
                        <div class="mb-3">
                            <label for="kppTanggal" class="form-label">Tanggal</label>
                            <input type="date" class="form-control" id="kppTanggal" required>
                        </div>
                         <div class="mb-3">
                            <label for="kppShift" class="form-label">Shift</label>
                            <select class="form-select" id="kppShift" required>
                                <option value="" selected disabled>Pilih Shift</option>
                                <option value="1">Shift 1</option>
                                <option value="2">Shift 2</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="kppJumlah" class="form-label">Jumlah NG</label>
                            <input type="number" class="form-control" id="kppJumlah" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label for="kppKeterangan" class="form-label">Keterangan</label>
                            <textarea class="form-control" id="kppKeterangan" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" id="kppSubmitBtn">
                            <span id="kppSubmitText">Simpan Data KPP</span>
                            <span id="kppSubmitSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                    </form>
                    <div id="kppStatusMessage" class="status-message mt-3 d-none"></div>
                </div>
            </section>
        </main>
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="#" class="nav-item" id="homeNavKpp">
                <i class="bi bi-house"></i>
                <span>Home</span>
            </a>
            <a href="#" class="nav-item" id="inputNavKpp">
                <i class="bi bi-plus-circle"></i>
                <span>Input</span>
            </a>
             <a href="#" class="nav-item active" id="kppNavActive">
                <i class="bi bi-exclamation-triangle"></i>
                <span>KPP</span>
            </a>
            <a href="#" class="nav-item" id="profileNavKpp">
                <i class="bi bi-person"></i>
                <span>Profil</span>
            </a>
            <a href="#" class="nav-item" id="settingsNavKpp">
                <i class="bi bi-gear"></i>
                <span>Settings</span>
            </a>
        </nav>
    </div>
    <!-- Profile Page -->
    <div id="profilePage" class="page">
        <!-- App Header -->
        <header class="app-header">
            <div class="app-header-title">Profil Pengguna</div>
            <div class="user-section">
                <div class="user-avatar" id="profileUserAvatar">U</div>
                <button class="logout-btn" id="profileLogoutBtn">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
            </div>
        </header>
        <!-- Main Content -->
        <main class="main-content">
            <section class="profile-section">
                <div class="profile-card">
                    <div class="profile-avatar" id="profileAvatar">U</div>
                    <h3 class="profile-name" id="profileName">Nama Pengguna</h3>
                    <div class="profile-email" id="profileEmail">email@contoh.com</div>
                    <div class="profile-info">
                        <div class="info-item">
                            <span class="info-label">Metode Login</span>
                            <span class="info-value" id="loginMethod">Username</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Tanggal Bergabung</span>
                            <span class="info-value" id="joinDate">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">UID</span>
                            <span class="info-value" id="userUid">-</span>
                        </div>
                    </div>
                    <button id="profileLogoutBtn2" class="btn btn-outline-danger w-100 mt-4">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </button>
                </div>
            </section>
        </main>
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="#" class="nav-item" id="homeNav3">
                <i class="bi bi-house"></i>
                <span>Home</span>
            </a>
            <a href="#" class="nav-item" id="inputNav3">
                <i class="bi bi-plus-circle"></i>
                <span>Input</span>
            </a>
            <a href="#" class="nav-item" id="kppNav3">
                <i class="bi bi-exclamation-triangle"></i>
                <span>KPP</span>
            </a>
            <a href="#" class="nav-item active" id="profileNav3">
                <i class="bi bi-person"></i>
                <span>Profil</span>
            </a>
            <a href="#" class="nav-item" id="settingsNav3">
                <i class="bi bi-gear"></i>
                <span>Settings</span>
            </a>
        </nav>
    </div>
    <!-- Settings Page -->
    <div id="settingsPage" class="page">
        <!-- App Header -->
        <header class="app-header">
            <div class="app-header-title">Pengaturan</div>
            <div class="user-section">
                <div class="user-avatar" id="settingsUserAvatar">U</div>
                <button class="logout-btn" id="settingsLogoutBtn">
                    <i class="bi bi-box-arrow-right"></i>
                </button>
            </div>
        </header>
        <!-- Main Content -->
        <main class="main-content">
            <section class="settings-section">
                <h2 class="section-title">Tampilan</h2>
                <div class="settings-item">
                    <span class="settings-label">Mode Gelap</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="darkModeToggle">
                        <label class="form-check-label" for="darkModeToggle"></label>
                    </div>
                </div>
            </section>
            <section class="settings-section">
                <h2 class="section-title">Keamanan</h2>
                <div class="settings-item">
                    <span class="settings-label">Waktu Logout Otomatis</span>
                    <select class="form-select form-select-sm" id="autoLogoutTime" style="width: auto;">
                        <option value="15">15 menit</option>
                        <option value="30" selected>30 menit</option>
                        <option value="45">45 menit</option>
                        <option value="60">1 jam</option>
                    </select>
                </div>
            </section>
            <section class="access-control-section">
                <h2 class="section-title">Hak Akses Pengguna</h2>
                <div class="access-control-item">
                    <span class="access-control-label">Line Produksi yang Dapat Diakses</span>
                    <div class="line-access-container" id="lineAccessContainer">
                        <!-- Line access checkboxes will be generated here -->
                    </div>
                </div>
                <div class="access-control-item">
                    <span class="access-control-label">Hak Input Data</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="inputPermissionToggle">
                        <label class="form-check-label" for="inputPermissionToggle"></label>
                    </div>
                </div>
                <div class="access-control-item">
                    <span class="access-control-label">Hak Edit/Hapus Data</span>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="editPermissionToggle">
                        <label class="form-check-label" for="editPermissionToggle"></label>
                    </div>
                </div>
                <div class="access-control-item">
                    <button class="btn btn-primary" id="savePermissionsBtn">Simpan Hak Akses</button>
                </div>
            </section>
            <section class="management-section">
                <h2 class="section-title">Manajemen Data Master</h2>
                <div class="management-item">
                    <span class="management-label">Line Produksi</span>
                    <div class="management-buttons">
                        <button class="btn btn-primary btn-management" id="manageLineBtn">
                            <i class="bi bi-pencil-square"></i> Kelola
                        </button>
                    </div>
                </div>
                <div class="management-item">
                    <span class="management-label">Part</span>
                    <div class="management-buttons">
                        <button class="btn btn-primary btn-management" id="managePartBtn">
                            <i class="bi bi-pencil-square"></i> Kelola
                        </button>
                    </div>
                </div>
                <div class="management-item">
                    <span class="management-label">Proses</span>
                    <div class="management-buttons">
                        <button class="btn btn-primary btn-management" id="manageProsesBtn">
                            <i class="bi bi-pencil-square"></i> Kelola
                        </button>
                    </div>
                </div>
                <div class="management-item">
                    <span class="management-label">Item NG</span>
                    <div class="management-buttons">
                        <button class="btn btn-primary btn-management" id="manageNgItemBtn">
                            <i class="bi bi-pencil-square"></i> Kelola
                        </button>
                    </div>
                </div>
            </section>
            <section class="settings-section">
                <h2 class="section-title">Tentang</h2>
                <div class="settings-item">
                    <span class="settings-label">Versi Aplikasi</span>
                    <span class="settings-value">v1.0</span>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Tahun</span>
                    <span class="settings-value">2025</span>
                </div>
            </section>
        </main>
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="#" class="nav-item" id="homeNav4">
                <i class="bi bi-house"></i>
                <span>Home</span>
            </a>
            <a href="#" class="nav-item" id="inputNav4">
                <i class="bi bi-plus-circle"></i>
                <span>Input</span>
            </a>
            <a href="#" class="nav-item" id="kppNav4">
                <i class="bi bi-exclamation-triangle"></i>
                <span>KPP</span>
            </a>
            <a href="#" class="nav-item" id="profileNav4">
                <i class="bi bi-person"></i>
                <span>Profil</span>
            </a>
            <a href="#" class="nav-item active" id="settingsNav4">
                <i class="bi bi-gear"></i>
                <span>Settings</span>
            </a>
        </nav>
    </div>
    <!-- Management Modals -->
    <!-- Line Management Modal -->
    <div class="modal fade" id="lineManagementModal" tabindex="-1" aria-labelledby="lineManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content management-modal-content">
                <div class="modal-header management-modal-header">
                    <h5 class="modal-title" id="lineManagementModalLabel">Kelola Line Produksi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body management-modal-body">
                    <form id="lineManagementForm">
                        <div class="management-form-group">
                            <label for="lineNameInput" class="management-form-label">Nama Line Produksi</label>
                            <input type="text" class="management-form-input" id="lineNameInput" required>
                            <div id="lineNameError" class="management-error d-none"></div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="saveLineBtn">Simpan Line</button>
                    </form>
                    <div class="management-list" id="lineList">
                        <!-- Line list will be populated here -->
                    </div>
                </div>
                <div class="modal-footer management-modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Part Management Modal -->
    <div class="modal fade" id="partManagementModal" tabindex="-1" aria-labelledby="partManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content management-modal-content">
                <div class="modal-header management-modal-header">
                    <h5 class="modal-title" id="partManagementModalLabel">Kelola Part</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body management-modal-body">
                    <form id="partManagementForm">
                        <div class="management-form-group">
                            <label for="partLineSelect" class="management-form-label">Line Produksi</label>
                            <select class="management-form-select" id="partLineSelect" required>
                                <option value="">Pilih Line Produksi</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                            <div id="partLineError" class="management-error d-none"></div>
                        </div>
                        <div class="management-form-group">
                            <label for="partNameInput" class="management-form-label">Nama Part</label>
                            <input type="text" class="management-form-input" id="partNameInput" required>
                            <div id="partNameError" class="management-error d-none"></div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="savePartBtn">Simpan Part</button>
                    </form>
                    <div class="management-list" id="partList">
                        <!-- Part list will be populated here -->
                    </div>
                </div>
                <div class="modal-footer management-modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Proses Management Modal -->
    <div class="modal fade" id="prosesManagementModal" tabindex="-1" aria-labelledby="prosesManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content management-modal-content">
                <div class="modal-header management-modal-header">
                    <h5 class="modal-title" id="prosesManagementModalLabel">Kelola Proses</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body management-modal-body">
                    <form id="prosesManagementForm">
                        <div class="management-form-group">
                            <label for="prosesLineSelect" class="management-form-label">Line Produksi</label>
                            <select class="management-form-select" id="prosesLineSelect" required>
                                <option value="">Pilih Line Produksi</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                            <div id="prosesLineError" class="management-error d-none"></div>
                        </div>
                        <div class="management-form-group">
                            <label for="prosesPartSelect" class="management-form-label">Part</label>
                            <select class="management-form-select" id="prosesPartSelect" required>
                                <option value="">Pilih Part</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                            <div id="prosesPartError" class="management-error d-none"></div>
                        </div>
                        <div class="management-form-group">
                            <label for="prosesNameInput" class="management-form-label">Nama Proses</label>
                            <input type="text" class="management-form-input" id="prosesNameInput" required>
                            <div id="prosesNameError" class="management-error d-none"></div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="saveProsesBtn">Simpan Proses</button>
                    </form>
                    <div class="management-list" id="prosesList">
                        <!-- Proses list will be populated here -->
                    </div>
                </div>
                <div class="modal-footer management-modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>
    <!-- NG Item Management Modal -->
    <div class="modal fade" id="ngItemManagementModal" tabindex="-1" aria-labelledby="ngItemManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content management-modal-content">
                <div class="modal-header management-modal-header">
                    <h5 class="modal-title" id="ngItemManagementModalLabel">Kelola Item NG</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body management-modal-body">
                    <form id="ngItemManagementForm">
                        <div class="management-form-group">
                            <label for="ngItemLineSelect" class="management-form-label">Line Produksi</label>
                            <select class="management-form-select" id="ngItemLineSelect" required>
                                <option value="">Pilih Line Produksi</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                            <div id="ngItemLineError" class="management-error d-none"></div>
                        </div>
                        <div class="management-form-group">
                            <label for="ngItemPartSelect" class="management-form-label">Part</label>
                            <select class="management-form-select" id="ngItemPartSelect" required>
                                <option value="">Pilih Part</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                            <div id="ngItemPartError" class="management-error d-none"></div>
                        </div>
                        <div class="management-form-group">
                            <label for="ngItemProsesSelect" class="management-form-label">Proses</label>
                            <select class="management-form-select" id="ngItemProsesSelect" required>
                                <option value="">Pilih Proses</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                            <div id="ngItemProsesError" class="management-error d-none"></div>
                        </div>
                        <div class="management-form-group">
                            <label for="ngItemNameInput" class="management-form-label">Nama Item NG</label>
                            <input type="text" class="management-form-input" id="ngItemNameInput" required>
                            <div id="ngItemNameError" class="management-error d-none"></div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="saveNgItemBtn">Simpan Item NG</button>
                    </form>
                    <div class="management-list" id="ngItemList">
                        <!-- NG Item list will be populated here -->
                    </div>
                </div>
                <div class="modal-footer management-modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Konfirmasi Hapus</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Apakah Anda yakin ingin menghapus data ini?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Hapus</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Custom Alert -->
    <div class="custom-alert-overlay" id="customAlert">
        <div class="custom-alert">
            <div class="custom-alert-header">
                <div class="custom-alert-title" id="alertTitle">Konfirmasi</div>
                <button class="custom-alert-close">&times;</button>
            </div>
            <div class="custom-alert-body" id="alertMessage">
                Apakah Anda yakin ingin melanjutkan?
            </div>
            <div class="custom-alert-footer">
                <button class="custom-alert-btn custom-alert-btn-cancel" id="alertCancelBtn">Batal</button>
                <button class="custom-alert-btn custom-alert-btn-confirm" id="alertConfirmBtn">OK</button>
            </div>
        </div>
    </div>
    <!-- Auto Logout Warning -->
    <div class="auto-logout-warning hidden" id="autoLogoutWarning">
        <i class="bi bi-clock-history"></i>
        <span>Sesi akan berakhir dalam <span class="auto-logout-timer" id="autoLogoutTimer">00:00</span></span>
        <div class="auto-logout-buttons">
            <button class="auto-logout-btn auto-logout-stay" id="stayLoggedInBtn">Tetap Login</button>
            <button class="auto-logout-btn auto-logout-logout" id="logoutNowBtn">Logout</button>
        </div>
    </div>
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, getDoc, doc, updateDoc, deleteDoc, query, where, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
        // Your web app's Firebase configuration
            const firebaseConfig = {
            apiKey: "AIzaSyCqy_JbfO4zBfrRjbyapxZLN6cNxJYfTPo",
            authDomain: "main-3fdb7.firebaseapp.com",
            projectId: "main-3fdb7",
            storageBucket: "main-3fdb7.firebasestorage.app",
            messagingSenderId: "941850224922",
            appId: "1:941850224922:web:52612af8c75eb53b0ae4a3",
            measurementId: "G-KFEG3V64DW"
            };
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        // Initialize Firebase services
        const db = getFirestore(app);
        const auth = getAuth(app);
        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const homePage = document.getElementById('homePage');
        const inputPage = document.getElementById('inputPage');
        const kppInputPage = document.getElementById('kppInputPage');
        const profilePage = document.getElementById('profilePage');
        const settingsPage = document.getElementById('settingsPage');
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        // Custom Alert Elements
        const customAlert = document.getElementById('customAlert');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');
        const alertConfirmBtn = document.getElementById('alertConfirmBtn');
        const alertCancelBtn = document.getElementById('alertCancelBtn');
        const alertCloseBtn = document.querySelector('.custom-alert-close');
        // Login Page Elements
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const loginText = document.getElementById('loginText');
        const loginSpinner = document.getElementById('loginSpinner');
        const loginStatus = document.getElementById('loginStatus');
        // Home Page Elements
        const homeUserAvatar = document.getElementById('homeUserAvatar');
        const homeLogoutBtn = document.getElementById('homeLogoutBtn');
        const dataContainer = document.getElementById('dataContainer');
        const noDataMessage = document.getElementById('noDataMessage');
        const currentMonth = document.getElementById('currentMonth');
        const prevMonth = document.getElementById('prevMonth');
        const nextMonth = document.getElementById('nextMonth');
        const dashboardDateRange = document.getElementById('dashboardDateRange');
        const totalProduction = document.getElementById('totalProduction');
        const totalLoadingTime = document.getElementById('totalLoadingTime');
        const tableHeader = document.getElementById('tableHeader');
        const lineTableBody = document.getElementById('lineTableBody');
        // Input Page Elements
        const inputPageTitle = document.getElementById('inputPageTitle');
        const inputUserAvatar = document.getElementById('inputUserAvatar');
        const inputLogoutBtn = document.getElementById('inputLogoutBtn');
        const productionForm = document.getElementById('productionForm');
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        const submitSpinner = document.getElementById('submitSpinner');
        const inputStatusMessage = document.getElementById('inputStatusMessage');
        const shiftSelect = document.getElementById('shift');
        const shiftInfo = document.getElementById('shiftInfo');
        const lineSelect = document.getElementById('namaLineProduksi');
        const partSelect = document.getElementById('namaPart');
        const documentIdInput = document.getElementById('documentId');
        const formTitle = document.getElementById('formTitle');
        // KPP Page Elements
        const kppUserAvatar = document.getElementById('kppUserAvatar');
        const kppLogoutBtn = document.getElementById('kppLogoutBtn');
        const kppForm = document.getElementById('kppForm');
        const kppSubmitBtn = document.getElementById('kppSubmitBtn');
        const kppSubmitText = document.getElementById('kppSubmitText');
        const kppSubmitSpinner = document.getElementById('kppSubmitSpinner');
        const kppStatusMessage = document.getElementById('kppStatusMessage');
        const kppLineSelect = document.getElementById('kppLineProduksi');
        const kppPartSelect = document.getElementById('kppPart');
        const kppProsesSelect = document.getElementById('kppProses');
        const kppItemNgSelect = document.getElementById('kppItemNG');
        const kppNgDropdown = document.getElementById('kppNgDropdown');
        const kppDocumentIdInput = document.getElementById('kppDocumentId');
        // Profile Page Elements
        const profileUserAvatar = document.getElementById('profileUserAvatar');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const loginMethod = document.getElementById('loginMethod');
        const joinDate = document.getElementById('joinDate');
        const userUid = document.getElementById('userUid');
        const profileLogoutBtn = document.getElementById('profileLogoutBtn');
        const profileLogoutBtn2 = document.getElementById('profileLogoutBtn2');
        // Settings Page Elements
        const settingsUserAvatar = document.getElementById('settingsUserAvatar');
        const settingsLogoutBtn = document.getElementById('settingsLogoutBtn');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const autoLogoutTime = document.getElementById('autoLogoutTime');
        const lineAccessContainer = document.getElementById('lineAccessContainer');
        const inputPermissionToggle = document.getElementById('inputPermissionToggle');
        const editPermissionToggle = document.getElementById('editPermissionToggle');
        const savePermissionsBtn = document.getElementById('savePermissionsBtn');
        // Management Buttons
        const manageLineBtn = document.getElementById('manageLineBtn');
        const managePartBtn = document.getElementById('managePartBtn');
        const manageProsesBtn = document.getElementById('manageProsesBtn');
        const manageNgItemBtn = document.getElementById('manageNgItemBtn');
        // Management Modals
        const lineManagementModal = new bootstrap.Modal(document.getElementById('lineManagementModal'));
        const partManagementModal = new bootstrap.Modal(document.getElementById('partManagementModal'));
        const prosesManagementModal = new bootstrap.Modal(document.getElementById('prosesManagementModal'));
        const ngItemManagementModal = new bootstrap.Modal(document.getElementById('ngItemManagementModal'));
        // Management Form Elements
        const lineManagementForm = document.getElementById('lineManagementForm');
        const lineNameInput = document.getElementById('lineNameInput');
        const lineNameError = document.getElementById('lineNameError');
        const saveLineBtn = document.getElementById('saveLineBtn');
        const lineList = document.getElementById('lineList');
        
        const partManagementForm = document.getElementById('partManagementForm');
        const partLineSelect = document.getElementById('partLineSelect');
        const partNameInput = document.getElementById('partNameInput');
        const partLineError = document.getElementById('partLineError');
        const partNameError = document.getElementById('partNameError');
        const savePartBtn = document.getElementById('savePartBtn');
        const partList = document.getElementById('partList');
        
        const prosesManagementForm = document.getElementById('prosesManagementForm');
        const prosesLineSelect = document.getElementById('prosesLineSelect');
        const prosesPartSelect = document.getElementById('prosesPartSelect');
        const prosesNameInput = document.getElementById('prosesNameInput');
        const prosesLineError = document.getElementById('prosesLineError');
        const prosesPartError = document.getElementById('prosesPartError');
        const prosesNameError = document.getElementById('prosesNameError');
        const saveProsesBtn = document.getElementById('saveProsesBtn');
        const prosesList = document.getElementById('prosesList');
        
        const ngItemManagementForm = document.getElementById('ngItemManagementForm');
        const ngItemLineSelect = document.getElementById('ngItemLineSelect');
        const ngItemPartSelect = document.getElementById('ngItemPartSelect');
        const ngItemProsesSelect = document.getElementById('ngItemProsesSelect');
        const ngItemNameInput = document.getElementById('ngItemNameInput');
        const ngItemLineError = document.getElementById('ngItemLineError');
        const ngItemPartError = document.getElementById('ngItemPartError');
        const ngItemProsesError = document.getElementById('ngItemProsesError');
        const ngItemNameError = document.getElementById('ngItemNameError');
        const saveNgItemBtn = document.getElementById('saveNgItemBtn');
        const ngItemList = document.getElementById('ngItemList');
        // Navigation Elements
        const homeNav = document.getElementById('homeNav');
        const inputNav = document.getElementById('inputNav');
        const kppNav = document.getElementById('kppNav');
        const profileNav = document.getElementById('profileNav');
        const settingsNav = document.getElementById('settingsNav');
        const homeNav2 = document.getElementById('homeNav2');
        const inputNav2 = document.getElementById('inputNav2');
        const kppNav2 = document.getElementById('kppNav2');
        const profileNav2 = document.getElementById('profileNav2');
        const settingsNav2 = document.getElementById('settingsNav2');
        const homeNav3 = document.getElementById('homeNav3');
        const inputNav3 = document.getElementById('inputNav3');
        const kppNav3 = document.getElementById('kppNav3');
        const profileNav3 = document.getElementById('profileNav3');
        const settingsNav3 = document.getElementById('settingsNav3');
        const homeNav4 = document.getElementById('homeNav4');
        const inputNav4 = document.getElementById('inputNav4');
        const kppNav4 = document.getElementById('kppNav4');
        const profileNav4 = document.getElementById('profileNav4');
        const settingsNav4 = document.getElementById('settingsNav4');
        const homeNavKpp = document.getElementById('homeNavKpp');
        const inputNavKpp = document.getElementById('inputNavKpp');
        const kppNavActive = document.getElementById('kppNavActive');
        const profileNavKpp = document.getElementById('profileNavKpp');
        const settingsNavKpp = document.getElementById('settingsNavKpp');
        // Delete Modal Elements
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        // Filter Elements
        const filterLine = document.getElementById('filterLine');
        const filterPart = document.getElementById('filterPart');
        const filterGroup = document.getElementById('filterGroup');
        const filterShift = document.getElementById('filterShift');
        const resetFilterBtn = document.getElementById('resetFilterBtn');
        // Auto Logout Elements
        const autoLogoutWarning = document.getElementById('autoLogoutWarning');
        const autoLogoutTimer = document.getElementById('autoLogoutTimer');
        const stayLoggedInBtn = document.getElementById('stayLoggedInBtn');
        const logoutNowBtn = document.getElementById('logoutNowBtn');
        // Refresh Loading Popup
        const refreshLoadingPopup = document.getElementById('refreshLoadingPopup');
        // State variables
        let currentUser = null;
        let currentDate = new Date();
        let currentEditDocId = null;
        let userPermissions = null;
        // Auto Logout State
        let inactivityTimer;
        let warningTimer;
        let logoutTime = 30 * 60 * 1000; // Default 30 minutes
        let warningTime = 60 * 1000; // 1 minute warning
        let timeLeft = logoutTime;
        // Data master dari Firestore
        let lineData = []; // Array of line objects {id, name}
        let partData = []; // Array of part objects {id, lineId, lineName, name}
        let prosesData = []; // Array of proses objects {id, partId, partName, lineName, name}
        let ngItemData = []; // Array of ngItem objects {id, prosesId, prosesName, partName, lineName, name}
        // Refresh Loading Popup Functions
        function showRefreshLoading() {
            refreshLoadingPopup.classList.add('show');
        }
        function hideRefreshLoading() {
            refreshLoadingPopup.classList.remove('show');
        }
        // Tampilkan loading saat halaman dimuat
        showRefreshLoading();
        // Sembunyikan loading setelah semua konten dimuat
        window.addEventListener('load', function() {
            // Tambahkan sedikit delay agar terlihat jika loading sangat cepat
            setTimeout(hideRefreshLoading, 300);
        });
        // Custom Alert Functions
        function showAlert(title, message, onConfirm, showCancel = true) {
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            alertCancelBtn.style.display = showCancel ? 'block' : 'none';
            // Set up event listeners
            const confirmHandler = () => {
                closeAlert();
                if (onConfirm) onConfirm();
            };
            const cancelHandler = () => {
                closeAlert();
            };
            const closeHandler = () => {
                closeAlert();
            };
            alertConfirmBtn.addEventListener('click', confirmHandler, { once: true });
            alertCancelBtn.addEventListener('click', cancelHandler, { once: true });
            alertCloseBtn.addEventListener('click', closeHandler, { once: true });
            // Show alert
            customAlert.classList.add('show');
        }
        function closeAlert() {
            customAlert.classList.remove('show');
        }
        // Format date for display
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }
        // Format month for display
        function formatMonth(date) {
            const options = { year: 'numeric', month: 'long' };
            return date.toLocaleDateString('id-ID', options);
        }
        // Format date range for dashboard (1st to last day of current month)
        function formatDateRange() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const options = { day: 'numeric', month: 'long' };
            dashboardDateRange.textContent = `${firstDay.getDate()} - ${lastDay.getDate()} ${firstDay.toLocaleDateString('id-ID', options)} ${year}`;
        }
        // Update month display
        function updateMonthDisplay() {
            currentMonth.textContent = formatMonth(currentDate);
        }
        // Calculate dashboard statistics
        function calculateDashboardStats(dataList) {
            // Total production
            const totalProd = dataList.reduce((sum, data) => sum + data.sigmaProduksi, 0);
            totalProduction.textContent = totalProd.toLocaleString();
            // Total loading time
            const totalLoadTime = dataList.reduce((sum, data) => sum + data.loadingTime, 0);
            totalLoadingTime.textContent = totalLoadTime.toLocaleString();
        }
        // Helper function to format date as YYYY-MM-DD based on local time
        function formatDateToLocalYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        // Generate line monitoring table
        function generateLineMonitoringTable(dataList) {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            // Clear existing header content first
            tableHeader.innerHTML = '';
            // Create the main header row (tanggal) - Use insertRow/insertCell for better structure
            const headerRow = document.createElement('tr');
            const lineNameHeader = document.createElement('th');
            lineNameHeader.rowSpan = 2; // Span 2 rows
            lineNameHeader.textContent = 'Line Produksi';
            lineNameHeader.style.textAlign = 'center'; // Optional: Center align
            headerRow.appendChild(lineNameHeader);
            // Create sub-header row (Prod/LT)
            const subHeaderRow = document.createElement('tr');
            // Loop through days to create headers
            for (let day = 1; day <= daysInMonth; day++) {
                // Main header cell for the day (spans 2 columns)
                const dayHeader = document.createElement('th');
                dayHeader.colSpan = 2; // Span 2 columns for Prod & LT
                dayHeader.textContent = day;
                dayHeader.style.textAlign = 'center'; // Center align day number
                headerRow.appendChild(dayHeader);
                // Sub-header cells for 'Prod' and 'LT'
                const prodSubHeader = document.createElement('th');
                prodSubHeader.textContent = 'Prod';
                prodSubHeader.style.fontSize = '0.75rem';
                prodSubHeader.style.textAlign = 'center'; // Align sub-headers
                subHeaderRow.appendChild(prodSubHeader);
                const ltSubHeader = document.createElement('th');
                ltSubHeader.textContent = 'LT';
                ltSubHeader.style.fontSize = '0.75rem';
                ltSubHeader.style.textAlign = 'center'; // Align sub-headers
                subHeaderRow.appendChild(ltSubHeader);
            }
            // Append both header rows to the table header
            tableHeader.appendChild(headerRow);
            tableHeader.appendChild(subHeaderRow);
            // Group data by line, date, and shift
            // Store both sigmaProduksi (prod) and loadingTime (lt)
            const lineDataMap = {};
            dataList.forEach(data => {
                const line = data.namaLineProduksi;
                // Create dateKey using local date formatting to avoid timezone issues
                const dateKey = formatDateToLocalYYYYMMDD(new Date(data.tanggal));
                const shift = data.shift;
                if (!lineDataMap[line]) {
                    lineDataMap[line] = {};
                }
                if (!lineDataMap[line][dateKey]) {
                    lineDataMap[line][dateKey] = { '1': { prod: 0, lt: 0 }, '2': { prod: 0, lt: 0 } };
                }
                // Aggregate production and loading time
                lineDataMap[line][dateKey][shift].prod += data.sigmaProduksi;
                lineDataMap[line][dateKey][shift].lt += data.loadingTime;
            });
            // Generate table rows
            const lineNames = lineData.map(line => line.name);
            let tableRowsHTML = '';
            lineNames.forEach(lineName => {
                // Shift 1 row
                let shift1RowHTML = `<tr><td>${lineName} (Shift 1)</td>`;
                for (let day = 1; day <= daysInMonth; day++) {
                    // Create dateKey for header using local date formatting
                    const dateKey = formatDateToLocalYYYYMMDD(new Date(year, month, day));
                    const data = lineDataMap[lineName] && lineDataMap[lineName][dateKey];
                    if (data && (data['1'].prod > 0 || data['1'].lt > 0)) {
                        // Display Production and Loading Time side-by-side
                        shift1RowHTML += `<td style="text-align:right;">${data['1'].prod}</td><td style="text-align:right;">${data['1'].lt}</td>`;
                    } else {
                        shift1RowHTML += '<td>-</td><td>-</td>';
                    }
                }
                shift1RowHTML += '</tr>';
                tableRowsHTML += shift1RowHTML;
                // Shift 2 row
                let shift2RowHTML = `<tr><td>${lineName} (Shift 2)</td>`;
                for (let day = 1; day <= daysInMonth; day++) {
                    // Create dateKey for header using local date formatting
                    const dateKey = formatDateToLocalYYYYMMDD(new Date(year, month, day));
                    const data = lineDataMap[lineName] && lineDataMap[lineName][dateKey];
                    if (data && (data['2'].prod > 0 || data['2'].lt > 0)) {
                        // Display Production and Loading Time side-by-side
                        shift2RowHTML += `<td style="text-align:right;">${data['2'].prod}</td><td style="text-align:right;">${data['2'].lt}</td>`;
                    } else {
                        shift2RowHTML += '<td>-</td><td>-</td>';
                    }
                }
                shift2RowHTML += '</tr>';
                tableRowsHTML += shift2RowHTML;
                // Separator row
                // Adjust colspan to account for double columns (days * 2) + line name column
                tableRowsHTML += `<tr class="shift-separator"><td colspan="${(daysInMonth * 2) + 1}"></td></tr>`;
            });
            lineTableBody.innerHTML = tableRowsHTML;
        }
        // Fungsi untuk mengisi opsi part berdasarkan line yang dipilih di filter
        function updateFilterPartOptions() {
            const selectedLine = filterLine.value;
            filterPart.innerHTML = '<option value="">Semua Part</option>';
            if (selectedLine) {
                const parts = partData.filter(part => part.lineName === selectedLine);
                parts.forEach(part => {
                    const option = document.createElement('option');
                    option.value = part.name;
                    option.textContent = part.name;
                    filterPart.appendChild(option);
                });
            }
        }
        // Fetch master data from Firestore
        async function fetchMasterData() {
            try {
                // Fetch lines
                const lineSnapshot = await getDocs(collection(db, "lines"));
                lineData = [];
                lineSnapshot.forEach((doc) => {
                    lineData.push({ id: doc.id, ...doc.data() });
                });
                // Fetch parts
                const partSnapshot = await getDocs(collection(db, "parts"));
                partData = [];
                partSnapshot.forEach((doc) => {
                    partData.push({ id: doc.id, ...doc.data() });
                });
                // Fetch proses
                const prosesSnapshot = await getDocs(collection(db, "proses"));
                prosesData = [];
                prosesSnapshot.forEach((doc) => {
                    prosesData.push({ id: doc.id, ...doc.data() });
                });
                // Fetch ngItems
                const ngItemSnapshot = await getDocs(collection(db, "ngItems"));
                ngItemData = [];
                ngItemSnapshot.forEach((doc) => {
                    ngItemData.push({ id: doc.id, ...doc.data() });
                });
                // Update dropdowns with fetched data
                updateLineDropdowns();
            } catch (error) {
                console.error("Error fetching master data: ", error);
                showAlert('Error', 'Gagal memuat data master: ' + error.message);
            }
        }
        // Update line dropdowns with fetched data
        function updateLineDropdowns() {
            // Update line dropdowns in all forms
            const lineSelects = [lineSelect, kppLineSelect, filterLine, partLineSelect, prosesLineSelect, ngItemLineSelect];
            lineSelects.forEach(select => {
                // Clear existing options except the first one
                while (select.options.length > 1) {
                    select.remove(1);
                }
                // Add new options
                lineData.forEach(line => {
                    const option = document.createElement('option');
                    option.value = line.name;
                    option.textContent = line.name;
                    select.appendChild(option);
                });
            });
        }
        // Update part options based on selected line
        function updatePartOptions() {
            const selectedLine = lineSelect.value;
            partSelect.innerHTML = '<option value="" selected disabled>Pilih Part</option>';
            partSelect.disabled = true;
            if (selectedLine) {
                const parts = partData.filter(part => part.lineName === selectedLine);
                if (parts.length > 0) {
                    partSelect.disabled = false;
                    parts.forEach(part => {
                        const option = document.createElement('option');
                        option.value = part.name;
                        option.textContent = part.name;
                        partSelect.appendChild(option);
                    });
                }
            }
        }
        // Update part options for KPP based on selected line
        function updateKppPartOptions() {
            const selectedLine = kppLineSelect.value;
            kppPartSelect.innerHTML = '<option value="" selected disabled>Pilih Part</option>';
            kppProsesSelect.innerHTML = '<option value="" selected disabled>Pilih Part Terlebih Dahulu</option>';
            kppNgDropdown.innerHTML = '';
            kppItemNgSelect.value = '';
            kppProsesSelect.disabled = true;
            kppNgDropdown.classList.add('d-none');
            kppPartSelect.disabled = true;
            if (selectedLine) {
                const parts = partData.filter(part => part.lineName === selectedLine);
                if (parts.length > 0) {
                    kppPartSelect.disabled = false;
                    parts.forEach(part => {
                        const option = document.createElement('option');
                        option.value = part.name;
                        option.textContent = part.name;
                        kppPartSelect.appendChild(option);
                    });
                }
            }
        }
        // Update proses options for KPP based on selected line and part
        function updateKppProsesOptions() {
            const selectedLine = kppLineSelect.value;
            const selectedPart = kppPartSelect.value;
            kppProsesSelect.innerHTML = '<option value="" selected disabled>Pilih Proses</option>';
            kppNgDropdown.innerHTML = '';
            kppItemNgSelect.value = '';
            kppNgDropdown.classList.add('d-none');
            kppProsesSelect.disabled = true;
            if (selectedLine && selectedPart) {
                const prosesList = prosesData.filter(proses => proses.lineName === selectedLine && proses.partName === selectedPart);
                if (prosesList.length > 0) {
                    kppProsesSelect.disabled = false;
                    prosesList.forEach(proses => {
                        const option = document.createElement('option');
                        option.value = proses.name;
                        option.textContent = proses.name;
                        kppProsesSelect.appendChild(option);
                    });
                }
            }
        }
        // Show NG items dropdown when proses is selected
        function showKppNgItems() {
            const selectedLine = kppLineSelect.value;
            const selectedPart = kppPartSelect.value;
            const selectedProses = kppProsesSelect.value;
            
            kppNgDropdown.innerHTML = '';
            kppItemNgSelect.value = '';
            
            if (selectedLine && selectedPart && selectedProses) {
                const ngItems = ngItemData.filter(ngItem => 
                    ngItem.lineName === selectedLine && 
                    ngItem.partName === selectedPart && 
                    ngItem.prosesName === selectedProses
                );
                
                if (ngItems.length > 0) {
                    ngItems.forEach(item => {
                        const ngItemElement = document.createElement('div');
                        ngItemElement.className = 'kpp-ng-item';
                        ngItemElement.textContent = item.name;
                        ngItemElement.addEventListener('click', () => {
                            kppItemNgSelect.value = item.name;
                            kppNgDropdown.classList.add('d-none');
                        });
                        kppNgDropdown.appendChild(ngItemElement);
                    });
                    
                    kppNgDropdown.classList.remove('d-none');
                } else {
                    kppNgDropdown.classList.add('d-none');
                }
            } else {
                kppNgDropdown.classList.add('d-none');
            }
        }
        // Fetch data from Firestore
        async function fetchData() {
            try {
                // Calculate start and end of current month using local time
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const startDate = new Date(year, month, 1);
                const endDate = new Date(year, month + 1, 0, 23, 59, 59);
                // Format dates to YYYY-MM-DD for querying
                const startDateString = formatDateToLocalYYYYMMDD(startDate);
                const endDateString = formatDateToLocalYYYYMMDD(endDate);
                // Query data for the current month
                const q = query(
                    collection(db, "produksiData"),
                    where("tanggal", ">=", startDateString),
                    where("tanggal", "<=", endDateString),
                    orderBy("tanggal", "desc")
                );
                const querySnapshot = await getDocs(q);
                const dataList = [];
                querySnapshot.forEach((doc) => {
                    dataList.push({ id: doc.id, ...doc.data() });
                });
                // Simpan data lengkap untuk filter
                window.fullDataList = dataList;
                // Update dashboard
                calculateDashboardStats(dataList);
                generateLineMonitoringTable(dataList);
                // Render recent data list
                renderData(dataList);
            } catch (error) {
                console.error("Error fetching data: ", error);
                showAlert('Error', 'Gagal memuat data: ' + error.message);
            }
        }
        // Render data to UI dengan filter
        function renderData(fullDataList) {
            // Terapkan filter
            let filteredDataList = [...fullDataList]; // Salin array untuk menghindari mutasi langsung
            // Filter berdasarkan hak akses pengguna
            if (userPermissions && userPermissions.accessibleLines) {
                filteredDataList = filteredDataList.filter(data => 
                    userPermissions.accessibleLines.includes(data.namaLineProduksi)
                );
            }
            if (filterLine.value) {
                filteredDataList = filteredDataList.filter(data => data.namaLineProduksi === filterLine.value);
            }
            if (filterPart.value) {
                filteredDataList = filteredDataList.filter(data => data.namaPart === filterPart.value);
            }
            if (filterGroup.value) {
                filteredDataList = filteredDataList.filter(data => data.group === filterGroup.value);
            }
            if (filterShift.value) {
                filteredDataList = filteredDataList.filter(data => data.shift === filterShift.value);
            }
            if (filteredDataList.length === 0) {
                noDataMessage.style.display = 'block';
                dataContainer.innerHTML = '';
                dataContainer.appendChild(noDataMessage);
                return;
            }
            noDataMessage.style.display = 'none';
            dataContainer.innerHTML = '';
            // Tampilkan data yang sudah difilter
            filteredDataList.forEach(data => {
                const dataCard = document.createElement('div');
                dataCard.className = 'data-card';
                dataCard.innerHTML = `
                    <div class="data-header">
                        <div class="data-title">${data.namaLineProduksi} - ${data.namaPart}</div>
                        <div class="data-date">${formatDate(data.tanggal)}</div>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Group:</span>
                        <span class="data-value">${data.group}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Shift:</span>
                        <span class="data-value">${data.shift}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Total Produksi:</span>
                        <span class="data-value">${data.sigmaProduksi}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Loading Time:</span>
                        <span class="data-value">${data.loadingTime} menit</span>
                    </div>
                    <div class="action-buttons">
                        ${userPermissions && userPermissions.canEdit ? `
                            <button class="btn-edit" data-id="${data.id}">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn-delete" data-id="${data.id}">
                                <i class="bi bi-trash"></i> Hapus
                            </button>
                        ` : `
                            <button class="btn-edit" data-id="${data.id}" disabled>
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn-delete" data-id="${data.id}" disabled>
                                <i class="bi bi-trash"></i> Hapus
                            </button>
                        `}
                    </div>
                `;
                dataContainer.appendChild(dataCard);
            });
            // Tambahkan event listener untuk tombol edit dan hapus jika pengguna memiliki hak akses
            if (userPermissions && userPermissions.canEdit) {
                document.querySelectorAll('.btn-edit').forEach(button => {
                    if (!button.disabled) {
                        button.addEventListener('click', (e) => {
                            const docId = e.currentTarget.getAttribute('data-id');
                            editData(docId);
                        });
                    }
                });
                document.querySelectorAll('.btn-delete').forEach(button => {
                    if (!button.disabled) {
                        button.addEventListener('click', (e) => {
                            const docId = e.currentTarget.getAttribute('data-id');
                            showDeleteConfirmation(docId);
                        });
                    }
                });
            }
        }
        // Edit data
        async function editData(docId) {
            // Cek hak akses edit
            if (!userPermissions || !userPermissions.canEdit) {
                showAlert('Akses Ditolak', 'Anda tidak memiliki hak akses untuk mengedit data.');
                return;
            }
            try {
                const docRef = doc(db, "produksiData", docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Cek apakah user memiliki akses ke line produksi ini
                    if (userPermissions.accessibleLines && 
                        !userPermissions.accessibleLines.includes(data.namaLineProduksi)) {
                        showAlert('Akses Ditolak', 'Anda tidak memiliki hak akses untuk mengedit data line produksi ini.');
                        return;
                    }
                    // Set form values
                    documentIdInput.value = docId;
                    document.getElementById('namaLineProduksi').value = data.namaLineProduksi;
                    updatePartOptions(); // Update part options first
                    document.getElementById('namaPart').value = data.namaPart;
                    document.getElementById('tanggal').value = data.tanggal;
                    document.getElementById('group').value = data.group;
                    document.getElementById('shift').value = data.shift;
                    document.getElementById('sigmaProduksi').value = data.sigmaProduksi;
                    document.getElementById('sigmaOP').value = data.sigmaOP;
                    document.getElementById('loadingTime').value = data.loadingTime;
                    // Update shift info
                    updateShiftInfo();
                    // Change form title and button text
                    formTitle.textContent = 'Edit Data Produksi';
                    inputPageTitle.textContent = 'Edit Data';
                    submitText.textContent = 'Update Data';
                    // Enable part select
                    document.getElementById('namaPart').disabled = false;
                    // Show input page
                    showPage('inputPage');
                } else {
                    showAlert('Error', 'Dokumen tidak ditemukan!');
                }
            } catch (error) {
                console.error("Error getting document: ", error);
                showAlert('Error', 'Gagal mengambil data: ' + error.message);
            }
        }
        // Show delete confirmation
        function showDeleteConfirmation(docId) {
            // Cek hak akses hapus
            if (!userPermissions || !userPermissions.canEdit) {
                showAlert('Akses Ditolak', 'Anda tidak memiliki hak akses untuk menghapus data.');
                return;
            }
            currentEditDocId = docId;
            deleteModal.show();
        }
        // Delete data
        async function deleteData() {
            if (!currentEditDocId) return;
            try {
                await deleteDoc(doc(db, "produksiData", currentEditDocId));
                console.log("Document successfully deleted!");
                deleteModal.hide();
                fetchData(); // Refresh data
                showAlert('Sukses', 'Data berhasil dihapus!');
            } catch (error) {
                console.error("Error deleting document: ", error);
                showAlert('Error', 'Gagal menghapus data: ' + error.message);
            }
        }
        // Update shift information
        function updateShiftInfo() {
            const shift = shiftSelect.value;
            if (shift === '1') {
                shiftInfo.innerHTML = 'Jam Kerja: 07.10 - 16.10<br>Lembur: 1 jam (17.30) / 2 jam (18.30)';
                shiftInfo.classList.remove('d-none');
            } else if (shift === '2') {
                shiftInfo.innerHTML = 'Jam Kerja: 19.50 - 04.50<br>Lembur: 1 jam (06.10) / 2 jam (07.10)';
                shiftInfo.classList.remove('d-none');
            } else {
                shiftInfo.classList.add('d-none');
            }
        }
        // Set loading state for login button
        function setLoginLoading(isLoading) {
            if (isLoading) {
                loginText.textContent = 'Memverifikasi...';
                loginSpinner.classList.remove('d-none');
                loginBtn.disabled = true;
            } else {
                loginText.textContent = 'Login';
                loginSpinner.classList.add('d-none');
                loginBtn.disabled = false;
            }
        }
        // Show login status message
        function showLoginStatus(message, isError = false) {
            loginStatus.textContent = message;
            loginStatus.className = `status-message mt-3 ${isError ? 'alert alert-danger' : 'd-none'}`;
        }
        // Set loading state for submit button
        function setInputLoading(isLoading) {
            if (isLoading) {
                submitText.textContent = documentIdInput.value ? 'Memperbarui...' : 'Menyimpan...';
                submitSpinner.classList.remove('d-none');
                submitBtn.disabled = true;
            } else {
                submitText.textContent = documentIdInput.value ? 'Update Data' : 'Simpan Data';
                submitSpinner.classList.add('d-none');
                submitBtn.disabled = false;
            }
        }
        // Show input status message
        function showInputStatus(message, isError = false) {
            inputStatusMessage.textContent = message;
            inputStatusMessage.className = `status-message mt-3 ${isError ? 'alert alert-danger' : 'alert alert-success'} ${message ? '' : 'd-none'}`;
        }
        // Reset form
        function resetForm() {
            productionForm.reset();
            documentIdInput.value = '';
            shiftInfo.classList.add('d-none');
            partSelect.disabled = true;
            partSelect.innerHTML = '<option value="" selected disabled>Pilih Line Produksi Terlebih Dahulu</option>';
            formTitle.textContent = 'Input Data Produksi';
            inputPageTitle.textContent = 'Input Data';
            submitText.textContent = 'Simpan Data';
        }
        // Set loading state for KPP submit button
        function setKppInputLoading(isLoading) {
            if (isLoading) {
                kppSubmitText.textContent = kppDocumentIdInput.value ? 'Memperbarui...' : 'Menyimpan...';
                kppSubmitSpinner.classList.remove('d-none');
                kppSubmitBtn.disabled = true;
            } else {
                kppSubmitText.textContent = 'Simpan Data KPP';
                kppSubmitSpinner.classList.add('d-none');
                kppSubmitBtn.disabled = false;
            }
        }
        // Show KPP input status message
        function showKppStatus(message, isError = false) {
            kppStatusMessage.textContent = message;
            kppStatusMessage.className = `status-message mt-3 ${isError ? 'alert alert-danger' : 'alert alert-success'} ${message ? '' : 'd-none'}`;
        }
        // Reset KPP form
        function resetKppForm() {
            kppForm.reset();
            kppDocumentIdInput.value = '';
            kppPartSelect.disabled = true;
            kppProsesSelect.disabled = true;
            kppNgDropdown.classList.add('d-none');
            kppPartSelect.innerHTML = '<option value="" selected disabled>Pilih Line Produksi Terlebih Dahulu</option>';
            kppProsesSelect.innerHTML = '<option value="" selected disabled>Pilih Part Terlebih Dahulu</option>';
            kppItemNgSelect.value = '';
             // Set today's date as default
            document.getElementById('kppTanggal').valueAsDate = new Date();
        }
        // Show/hide pages
        function showPage(pageId) {
            // Hide all pages
            loginPage.classList.remove('active');
            homePage.classList.remove('active');
            inputPage.classList.remove('active');
            kppInputPage.classList.remove('active');
            profilePage.classList.remove('active');
            settingsPage.classList.remove('active');
            // Show requested page
            document.getElementById(pageId).classList.add('active');
            // Update navigation active state
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if (pageId === 'homePage') {
                homeNav.classList.add('active');
                homeNav2.classList.add('active');
                homeNav3.classList.add('active');
                homeNav4.classList.add('active');
            } else if (pageId === 'inputPage') {
                inputNav.classList.add('active');
                inputNav2.classList.add('active');
                inputNav3.classList.add('active');
                inputNav4.classList.add('active');
            } else if (pageId === 'kppInputPage') {
                kppNav.classList.add('active');
                kppNav2.classList.add('active');
                kppNav3.classList.add('active');
                kppNav4.classList.add('active');
                kppNavActive.classList.add('active');
            } else if (pageId === 'profilePage') {
                profileNav.classList.add('active');
                profileNav2.classList.add('active');
                profileNav3.classList.add('active');
                profileNav4.classList.add('active');
            } else if (pageId === 'settingsPage') {
                settingsNav.classList.add('active');
                settingsNav2.classList.add('active');
                settingsNav3.classList.add('active');
                settingsNav4.classList.add('active');
            }
        }
        // Update user profile display
        function updateUserProfile(user) {
            if (user) {
                const displayName = user.displayName || user.email.split('@')[0];
                const avatarText = displayName.charAt(0).toUpperCase();
                // Update avatars
                homeUserAvatar.textContent = avatarText;
                inputUserAvatar.textContent = avatarText;
                kppUserAvatar.textContent = avatarText;
                profileUserAvatar.textContent = avatarText;
                settingsUserAvatar.textContent = avatarText;
                profileAvatar.textContent = avatarText;
                // Update profile info
                profileName.textContent = displayName;
                profileEmail.textContent = user.email;
                userUid.textContent = user.uid;
                // Set login method
                if (user.providerData && user.providerData.length > 0) {
                    const provider = user.providerData[0].providerId;
                    loginMethod.textContent = provider === 'google.com' ? 'Google' : 'Username';
                }
                // Set join date
                if (user.metadata && user.metadata.creationTime) {
                    const creationDate = new Date(user.metadata.creationTime);
                    joinDate.textContent = creationDate.toLocaleDateString('id-ID');
                }
            }
        }
        // Generate line access checkboxes
        function generateLineAccessCheckboxes() {
            lineAccessContainer.innerHTML = '';
            lineData.forEach(line => {
                const lineItem = document.createElement('div');
                lineItem.className = 'line-access-item';
                lineItem.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="line-${line.id}" value="${line.name}">
                        <label class="form-check-label" for="line-${line.id}">${line.name}</label>
                    </div>
                `;
                lineAccessContainer.appendChild(lineItem);
            });
        }
        // Update user permissions display
        function updateUserPermissionsDisplay() {
            if (userPermissions) {
                // Update accessible lines display
                const lineCheckboxes = lineAccessContainer.querySelectorAll('input[type="checkbox"]');
                lineCheckboxes.forEach(checkbox => {
                    checkbox.checked = userPermissions.accessibleLines.includes(checkbox.value);
                });
                // Update input permission display
                inputPermissionToggle.checked = userPermissions.canInput;
                // Update edit permission display
                editPermissionToggle.checked = userPermissions.canEdit;
            }
        }
        // Save user permissions
        async function saveUserPermissions() {
            if (!currentUser) return;
            // Get selected lines
            const selectedLines = [];
            const lineCheckboxes = lineAccessContainer.querySelectorAll('input[type="checkbox"]');
            lineCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedLines.push(checkbox.value);
                }
            });
            // Get permissions
            const canInput = inputPermissionToggle.checked;
            const canEdit = editPermissionToggle.checked;
            // Create permissions object
            const permissions = {
                uid: currentUser.uid,
                accessibleLines: selectedLines,
                canInput: canInput,
                canEdit: canEdit
            };
            try {
                // Save to Firestore
                const userPermissionsRef = doc(db, "userPermissions", currentUser.uid);
                await setDoc(userPermissionsRef, permissions);
                // Update local permissions
                userPermissions = permissions;
                showAlert('Sukses', 'Hak akses berhasil disimpan!');
            } catch (error) {
                console.error("Error saving permissions: ", error);
                showAlert('Error', 'Gagal menyimpan hak akses: ' + error.message);
            }
        }
        // Get user permissions from Firestore
        async function getUserPermissions(uid) {
            try {
                const userPermissionsRef = doc(db, "userPermissions", uid);
                const userPermissionsSnap = await getDoc(userPermissionsRef);
                if (userPermissionsSnap.exists()) {
                    return userPermissionsSnap.data();
                } else {
                    // Return default permissions if not found
                    return {
                        uid: uid,
                        accessibleLines: lineData.map(line => line.name),
                        canInput: true,
                        canEdit: true
                    };
                }
            } catch (error) {
                console.error("Error getting user permissions: ", error);
                return null;
            }
        }
        // Auto Logout Functions
        function startInactivityTimer() {
            resetInactivityTimer();
            // Add event listeners for user activity
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
                document.addEventListener(event, resetInactivityTimer, true);
            });
        }
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            clearTimeout(warningTimer);
            timeLeft = logoutTime;
            inactivityTimer = setTimeout(() => {
                showAutoLogoutWarning();
            }, logoutTime - warningTime);
        }
        function showAutoLogoutWarning() {
            autoLogoutWarning.classList.remove('hidden');
            updateAutoLogoutTimer();
            warningTimer = setInterval(() => {
                timeLeft -= 1000;
                updateAutoLogoutTimer();
                if (timeLeft <= 0) {
                    clearInterval(warningTimer);
                    performLogout();
                }
            }, 1000);
        }
        function updateAutoLogoutTimer() {
            const minutes = Math.floor(timeLeft / 60000);
            const seconds = Math.floor((timeLeft % 60000) / 1000);
            autoLogoutTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        function hideAutoLogoutWarning() {
            autoLogoutWarning.classList.add('hidden');
            clearInterval(warningTimer);
        }
        function updateLogoutTime() {
            const selectedTime = parseInt(autoLogoutTime.value);
            logoutTime = selectedTime * 60 * 1000;
            // Save to localStorage
            localStorage.setItem('autoLogoutTime', selectedTime);
            resetInactivityTimer();
        }
        // Dark Mode Functions
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            // Save preference to localStorage
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }
        function loadSettings() {
            // Load dark mode preference
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.checked = true;
            }
            // Load auto logout time
            const savedLogoutTime = localStorage.getItem('autoLogoutTime');
            if (savedLogoutTime) {
                autoLogoutTime.value = savedLogoutTime;
                logoutTime = parseInt(savedLogoutTime) * 60 * 1000;
            }
        }
        // Management Functions
        // Populate line select options
        function populateLineSelect(selectElement) {
            selectElement.innerHTML = '<option value="">Pilih Line Produksi</option>';
            lineData.forEach(line => {
                const option = document.createElement('option');
                option.value = line.name;
                option.textContent = line.name;
                selectElement.appendChild(option);
            });
        }
        
        // Populate part select options based on selected line
        function populatePartSelect(selectElement, lineName) {
            selectElement.innerHTML = '<option value="">Pilih Part</option>';
            if (lineName) {
                const parts = partData.filter(part => part.lineName === lineName);
                parts.forEach(part => {
                    const option = document.createElement('option');
                    option.value = part.name;
                    option.textContent = part.name;
                    selectElement.appendChild(option);
                });
            }
        }
        
        // Populate proses select options based on selected line and part
        function populateProsesSelect(selectElement, lineName, partName) {
            selectElement.innerHTML = '<option value="">Pilih Proses</option>';
            if (lineName && partName) {
                const prosesList = prosesData.filter(proses => proses.lineName === lineName && proses.partName === partName);
                prosesList.forEach(proses => {
                    const option = document.createElement('option');
                    option.value = proses.name;
                    option.textContent = proses.name;
                    selectElement.appendChild(option);
                });
            }
        }
        
        // Render line list
        function renderLineList() {
            lineList.innerHTML = '';
            lineData.forEach(line => {
                const lineItem = document.createElement('div');
                lineItem.className = 'management-list-item';
                lineItem.innerHTML = `
                    <div class="management-item-info">
                        <div class="management-item-name">${line.name}</div>
                    </div>
                    <div class="management-item-actions">
                        <button class="btn btn-danger btn-sm delete-line-btn" data-line-id="${line.id}" data-line-name="${line.name}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                lineList.appendChild(lineItem);
            });
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-line-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const lineId = e.currentTarget.getAttribute('data-line-id');
                    const lineName = e.currentTarget.getAttribute('data-line-name');
                    showAlert('Konfirmasi Hapus', `Apakah Anda yakin ingin menghapus line ${lineName}? Semua data terkait akan ikut terhapus.`, async () => {
                        try {
                            await deleteDoc(doc(db, "lines", lineId));
                            console.log("Line successfully deleted!");
                            // Refresh master data
                            await fetchMasterData();
                            renderLineList();
                            showAlert('Sukses', 'Line berhasil dihapus!');
                        } catch (error) {
                            console.error("Error deleting line: ", error);
                            showAlert('Error', 'Gagal menghapus line: ' + error.message);
                        }
                    });
                });
            });
        }
        
        // Render part list
        function renderPartList() {
            partList.innerHTML = '';
            partData.forEach(part => {
                const partItem = document.createElement('div');
                partItem.className = 'management-list-item';
                partItem.innerHTML = `
                    <div class="management-item-info">
                        <div class="management-item-name">${part.name}</div>
                        <div class="management-item-details">Line: ${part.lineName}</div>
                    </div>
                    <div class="management-item-actions">
                        <button class="btn btn-danger btn-sm delete-part-btn" data-part-id="${part.id}" data-part-name="${part.name}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                partList.appendChild(partItem);
            });
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-part-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const partId = e.currentTarget.getAttribute('data-part-id');
                    const partName = e.currentTarget.getAttribute('data-part-name');
                    showAlert('Konfirmasi Hapus', `Apakah Anda yakin ingin menghapus part ${partName}? Semua data terkait akan ikut terhapus.`, async () => {
                        try {
                            await deleteDoc(doc(db, "parts", partId));
                            console.log("Part successfully deleted!");
                            // Refresh master data
                            await fetchMasterData();
                            renderPartList();
                            showAlert('Sukses', 'Part berhasil dihapus!');
                        } catch (error) {
                            console.error("Error deleting part: ", error);
                            showAlert('Error', 'Gagal menghapus part: ' + error.message);
                        }
                    });
                });
            });
        }
        
        // Render proses list
        function renderProsesList() {
            prosesList.innerHTML = '';
            prosesData.forEach(proses => {
                const prosesItem = document.createElement('div');
                prosesItem.className = 'management-list-item';
                prosesItem.innerHTML = `
                    <div class="management-item-info">
                        <div class="management-item-name">${proses.name}</div>
                        <div class="management-item-details">Line: ${proses.lineName}, Part: ${proses.partName}</div>
                    </div>
                    <div class="management-item-actions">
                        <button class="btn btn-danger btn-sm delete-proses-btn" data-proses-id="${proses.id}" data-proses-name="${proses.name}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                prosesList.appendChild(prosesItem);
            });
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-proses-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const prosesId = e.currentTarget.getAttribute('data-proses-id');
                    const prosesName = e.currentTarget.getAttribute('data-proses-name');
                    showAlert('Konfirmasi Hapus', `Apakah Anda yakin ingin menghapus proses ${prosesName}? Semua data terkait akan ikut terhapus.`, async () => {
                        try {
                            await deleteDoc(doc(db, "proses", prosesId));
                            console.log("Proses successfully deleted!");
                            // Refresh master data
                            await fetchMasterData();
                            renderProsesList();
                            showAlert('Sukses', 'Proses berhasil dihapus!');
                        } catch (error) {
                            console.error("Error deleting proses: ", error);
                            showAlert('Error', 'Gagal menghapus proses: ' + error.message);
                        }
                    });
                });
            });
        }
        
        // Render NG item list
        function renderNgItemList() {
            ngItemList.innerHTML = '';
            ngItemData.forEach(ngItem => {
                const ngItemElement = document.createElement('div');
                ngItemElement.className = 'management-list-item';
                ngItemElement.innerHTML = `
                    <div class="management-item-info">
                        <div class="management-item-name">${ngItem.name}</div>
                        <div class="management-item-details">Line: ${ngItem.lineName}, Part: ${ngItem.partName}, Proses: ${ngItem.prosesName}</div>
                    </div>
                    <div class="management-item-actions">
                        <button class="btn btn-danger btn-sm delete-ng-item-btn" data-ng-item-id="${ngItem.id}" data-ng-item-name="${ngItem.name}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                ngItemList.appendChild(ngItemElement);
            });
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-ng-item-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const ngItemId = e.currentTarget.getAttribute('data-ng-item-id');
                    const ngItemName = e.currentTarget.getAttribute('data-ng-item-name');
                    showAlert('Konfirmasi Hapus', `Apakah Anda yakin ingin menghapus item NG ${ngItemName}?`, async () => {
                        try {
                            await deleteDoc(doc(db, "ngItems", ngItemId));
                            console.log("NG Item successfully deleted!");
                            // Refresh master data
                            await fetchMasterData();
                            renderNgItemList();
                            showAlert('Sukses', 'Item NG berhasil dihapus!');
                        } catch (error) {
                            console.error("Error deleting NG item: ", error);
                            showAlert('Error', 'Gagal menghapus item NG: ' + error.message);
                        }
                    });
                });
            });
        }
        // Handle user state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                updateUserProfile(user);
                // Fetch master data first
                await fetchMasterData();
                // Get user permissions
                userPermissions = await getUserPermissions(user.uid);
                updateUserPermissionsDisplay();
                showPage('homePage');
                fetchData();
                updateMonthDisplay();
                formatDateRange();
                startInactivityTimer();
                // Filter line options based on user permissions
                filterLineOptions();
            } else {
                currentUser = null;
                userPermissions = null;
                hideAutoLogoutWarning();
                showPage('loginPage');
            }
        });
        // Filter line options based on user permissions
        function filterLineOptions() {
            if (userPermissions && userPermissions.accessibleLines) {
                // Filter options di halaman input produksi
                const inputLineOptions = lineSelect.querySelectorAll('option');
                inputLineOptions.forEach(option => {
                    if (option.value && !userPermissions.accessibleLines.includes(option.value)) {
                        option.disabled = true;
                        option.style.display = 'none';
                    }
                });
                // Filter options di halaman input KPP
                const kppLineOptions = kppLineSelect.querySelectorAll('option');
                kppLineOptions.forEach(option => {
                    if (option.value && !userPermissions.accessibleLines.includes(option.value)) {
                        option.disabled = true;
                        option.style.display = 'none';
                    }
                });
                // Filter options di filter home page
                const filterLineOptions = filterLine.querySelectorAll('option');
                filterLineOptions.forEach(option => {
                    if (option.value && !userPermissions.accessibleLines.includes(option.value)) {
                        option.disabled = true;
                        option.style.display = 'none';
                    }
                });
            }
        }
        // Email/password login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoginLoading(true);
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showLoginStatus('', false);
            } catch (error) {
                console.error("Login error: ", error);
                showLoginStatus('Email atau password salah!', true);
            } finally {
                setLoginLoading(false);
            }
        });
        // Logout functions
        async function performLogout() {
            try {
                await signOut(auth);
                hideAutoLogoutWarning();
            } catch (error) {
                console.error("Logout error: ", error);
                showAlert('Error', 'Gagal logout: ' + error.message);
            }
        }
        function logout() {
            showAlert('Konfirmasi Logout', 'Apakah Anda yakin ingin logout?', performLogout);
        }
        homeLogoutBtn.addEventListener('click', () => {
            showAlert('Konfirmasi Logout', 'Apakah Anda yakin ingin logout?', performLogout);
        });
        inputLogoutBtn.addEventListener('click', () => {
            showAlert('Konfirmasi Logout', 'Apakah Anda yakin ingin logout?', performLogout);
        });
        kppLogoutBtn.addEventListener('click', () => {
            showAlert('Konfirmasi Logout', 'Apakah Anda yakin ingin logout?', performLogout);
        });
        profileLogoutBtn.addEventListener('click', () => {
            showAlert('Konfirmasi Logout', 'Apakah Anda yakin ingin logout?', performLogout);
        });
        profileLogoutBtn2.addEventListener('click', () => {
            showAlert('Konfirmasi Logout', 'Apakah Anda yakin ingin logout?', performLogout);
        });
        settingsLogoutBtn.addEventListener('click', () => {
            showAlert('Konfirmasi Logout', 'Apakah Anda yakin ingin logout?', performLogout);
        });
        // Auto Logout Event Listeners
        stayLoggedInBtn.addEventListener('click', () => {
            hideAutoLogoutWarning();
            resetInactivityTimer();
        });
        logoutNowBtn.addEventListener('click', () => {
            hideAutoLogoutWarning();
            performLogout();
        });
        // Navigation
        homeNav.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('homePage');
        });
        inputNav.addEventListener('click', (e) => {
            e.preventDefault();
            // Cek hak akses input
            if (userPermissions && !userPermissions.canInput) {
                showAlert('Akses Ditolak', 'Anda tidak memiliki hak akses untuk input data.');
                return;
            }
            resetForm();
            showPage('inputPage');
            // Set today's date as default
            document.getElementById('tanggal').valueAsDate = new Date();
        });
        kppNav.addEventListener('click', (e) => {
            e.preventDefault();
            // Cek hak akses input
            if (userPermissions && !userPermissions.canInput) {
                showAlert('Akses Ditolak', 'Anda tidak memiliki hak akses untuk input data KPP.');
                return;
            }
            resetKppForm();
            showPage('kppInputPage');
            // Set today's date as default
            document.getElementById('kppTanggal').valueAsDate = new Date();
        });
        profileNav.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('profilePage');
        });
        settingsNav.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('settingsPage');
        });
        // Duplicate navigation for other nav items
        homeNav2.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('homePage');
        });
        inputNav2.addEventListener('click', (e) => {
            e.preventDefault();
            // Cek hak akses input
            if (userPermissions && !userPermissions.canInput) {
                showAlert('Akses Ditolak', 'Anda tidak memiliki hak akses untuk input data.');
                return;
            }
            resetForm();
            showPage('inputPage');
            document.getElementById('tanggal').valueAsDate = new Date();
        });
        kppNav2.addEventListener('click', (e) => {
            e.preventDefault();
            // Cek hak akses input
            if (userPermissions && !userPermissions.canInput) {
                showAlert('Akses Ditolak', 'Anda tidak memiliki hak akses untuk input data KPP.');
                return;
            }
            resetKppForm();
            showPage('kppInputPage');
            document.getElementById('kppTanggal').valueAsDate = new Date();
        });
        profileNav2.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('profilePage');
        });
        settingsNav2.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('settingsPage');
        });
        homeNav3.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('homePage');
        });
        inputNav3.addEventListener('click', (e) => {
            e.preventDefault();
            // Cek hak akses input
            if (userPermissions && !userPermissions.canInput) {
                showAlert('Akses Ditolak', 'Anda tidak memiliki hak akses untuk input data.');
                return;
            }
            resetForm();
            showPage('inputPage');
            document.getElementById('tanggal').valueAsDate = new Date();
        });
        kppNav3.addEventListener('click', (e) => {
            e.preventDefault();
            // Cek hak akses input
            if (userPermissions && !userPermissions.canInput) {
                showAlert('Akses Ditolak', 'Anda tidak memiliki hak akses untuk input data KPP.');
                return;
            }
            resetKppForm();
            showPage('kppInputPage');
            document.getElementById('kppTanggal').valueAsDate = new Date();
        });
        profileNav3.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('profilePage');
        });
        settingsNav3.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('settingsPage');
        });
        homeNav4.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('homePage');
        });
        inputNav4.addEventListener('click', (e) => {
            e.preventDefault();
            // Cek hak akses input
            if (userPermissions && !userPermissions.canInput) {
                showAlert('Akses Ditolak', 'Anda tidak memiliki hak akses untuk input data.');
                return;
            }
            resetForm();
            showPage('inputPage');
            document.getElementById('tanggal').valueAsDate = new Date();
        });
        kppNav4.addEventListener('click', (e) => {
            e.preventDefault();
            // Cek hak akses input
            if (userPermissions && !userPermissions.canInput) {
                showAlert('Akses Ditolak', 'Anda tidak memiliki hak akses untuk input data KPP.');
                return;
            }
            resetKppForm();
            showPage('kppInputPage');
            document.getElementById('kppTanggal').valueAsDate = new Date();
        });
        profileNav4.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('profilePage');
        });
        settingsNav4.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('settingsPage');
        });
        homeNavKpp.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('homePage');
        });
        inputNavKpp.addEventListener('click', (e) => {
            e.preventDefault();
            // Cek hak akses input
            if (userPermissions && !userPermissions.canInput) {
                showAlert('Akses Ditolak', 'Anda tidak memiliki hak akses untuk input data.');
                return;
            }
            resetForm();
            showPage('inputPage');
            document.getElementById('tanggal').valueAsDate = new Date();
        });
        profileNavKpp.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('profilePage');
        });
        settingsNavKpp.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('settingsPage');
        });
        // Month navigation
        prevMonth.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateMonthDisplay();
            formatDateRange();
            fetchData();
        });
        nextMonth.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateMonthDisplay();
            formatDateRange();
            fetchData();
        });
        // Input form event listeners
        lineSelect.addEventListener('change', updatePartOptions);
        shiftSelect.addEventListener('change', updateShiftInfo);
        // KPP form event listeners
        kppLineSelect.addEventListener('change', () => {
            updateKppPartOptions();
            // Reset downstream selects
            kppProsesSelect.innerHTML = '<option value="" selected disabled>Pilih Part Terlebih Dahulu</option>';
            kppNgDropdown.innerHTML = '';
            kppItemNgSelect.value = '';
            kppProsesSelect.disabled = true;
            kppNgDropdown.classList.add('d-none');
        });
        kppPartSelect.addEventListener('change', () => {
            updateKppProsesOptions();
            // Reset downstream select
            kppNgDropdown.innerHTML = '';
            kppItemNgSelect.value = '';
            kppNgDropdown.classList.add('d-none');
        });
        kppProsesSelect.addEventListener('change', showKppNgItems);
        // Click outside NG dropdown to close it
        document.addEventListener('click', (e) => {
            if (!kppProsesSelect.contains(e.target) && !kppNgDropdown.contains(e.target)) {
                kppNgDropdown.classList.add('d-none');
            }
        });
        // Settings event listeners
        darkModeToggle.addEventListener('change', toggleDarkMode);
        autoLogoutTime.addEventListener('change', updateLogoutTime);
        savePermissionsBtn.addEventListener('click', saveUserPermissions);
        // Management button event listeners
        manageLineBtn.addEventListener('click', () => {
            renderLineList();
            lineManagementModal.show();
        });
        managePartBtn.addEventListener('click', () => {
            populateLineSelect(partLineSelect);
            renderPartList();
            partManagementModal.show();
        });
        manageProsesBtn.addEventListener('click', () => {
            populateLineSelect(prosesLineSelect);
            prosesPartSelect.innerHTML = '<option value="">Pilih Part</option>';
            renderProsesList();
            prosesManagementModal.show();
        });
        manageNgItemBtn.addEventListener('click', () => {
            populateLineSelect(ngItemLineSelect);
            ngItemPartSelect.innerHTML = '<option value="">Pilih Part</option>';
            ngItemProsesSelect.innerHTML = '<option value="">Pilih Proses</option>';
            renderNgItemList();
            ngItemManagementModal.show();
        });
        // Management form event listeners
        lineManagementForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const lineName = lineNameInput.value.trim();
            
            if (!lineName) {
                lineNameError.textContent = 'Nama line tidak boleh kosong';
                lineNameError.classList.remove('d-none');
                return;
            }
            
            // Check if line already exists
            const lineExists = lineData.some(line => line.name === lineName);
            if (lineExists) {
                lineNameError.textContent = 'Line dengan nama ini sudah ada';
                lineNameError.classList.remove('d-none');
                return;
            }
            
            lineNameError.classList.add('d-none');
            
            try {
                // Save to Firestore
                await addDoc(collection(db, "lines"), { name: lineName });
                console.log("Line successfully added!");
                showAlert('Sukses', `Line ${lineName} berhasil ditambahkan!`);
                lineNameInput.value = '';
                // Refresh master data
                await fetchMasterData();
                renderLineList();
            } catch (error) {
                console.error("Error saving line: ", error);
                showAlert('Error', 'Gagal menyimpan line: ' + error.message);
            }
        });
        
        partManagementForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const lineName = partLineSelect.value;
            const partName = partNameInput.value.trim();
            
            if (!lineName) {
                partLineError.textContent = 'Pilih line produksi';
                partLineError.classList.remove('d-none');
                return;
            }
            
            if (!partName) {
                partNameError.textContent = 'Nama part tidak boleh kosong';
                partNameError.classList.remove('d-none');
                return;
            }
            
            partLineError.classList.add('d-none');
            partNameError.classList.add('d-none');
            
            // Check if part already exists for this line
            const partExists = partData.some(part => part.lineName === lineName && part.name === partName);
            if (partExists) {
                partNameError.textContent = 'Part dengan nama ini sudah ada untuk line ini';
                partNameError.classList.remove('d-none');
                return;
            }
            
            try {
                // Find lineId
                const line = lineData.find(l => l.name === lineName);
                if (!line) {
                    partLineError.textContent = 'Line tidak ditemukan';
                    partLineError.classList.remove('d-none');
                    return;
                }
                
                // Save to Firestore
                await addDoc(collection(db, "parts"), { 
                    lineId: line.id, 
                    lineName: line.name,
                    name: partName 
                });
                console.log("Part successfully added!");
                showAlert('Sukses', `Part ${partName} berhasil ditambahkan untuk line ${lineName}!`);
                partLineSelect.value = '';
                partNameInput.value = '';
                // Refresh master data
                await fetchMasterData();
                renderPartList();
            } catch (error) {
                console.error("Error saving part: ", error);
                showAlert('Error', 'Gagal menyimpan part: ' + error.message);
            }
        });
        
        prosesManagementForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const lineName = prosesLineSelect.value;
            const partName = prosesPartSelect.value;
            const prosesName = prosesNameInput.value.trim();
            
            if (!lineName) {
                prosesLineError.textContent = 'Pilih line produksi';
                prosesLineError.classList.remove('d-none');
                return;
            }
            
            if (!partName) {
                prosesPartError.textContent = 'Pilih part';
                prosesPartError.classList.remove('d-none');
                return;
            }
            
            if (!prosesName) {
                prosesNameError.textContent = 'Nama proses tidak boleh kosong';
                prosesNameError.classList.remove('d-none');
                return;
            }
            
            prosesLineError.classList.add('d-none');
            prosesPartError.classList.add('d-none');
            prosesNameError.classList.add('d-none');
            
            // Check if proses already exists for this line and part
            const prosesExists = prosesData.some(proses => 
                proses.lineName === lineName && 
                proses.partName === partName && 
                proses.name === prosesName
            );
            if (prosesExists) {
                prosesNameError.textContent = 'Proses dengan nama ini sudah ada untuk part ini';
                prosesNameError.classList.remove('d-none');
                return;
            }
            
            try {
                // Find partId
                const part = partData.find(p => p.lineName === lineName && p.name === partName);
                if (!part) {
                    prosesPartError.textContent = 'Part tidak ditemukan';
                    prosesPartError.classList.remove('d-none');
                    return;
                }
                
                // Save to Firestore
                await addDoc(collection(db, "proses"), { 
                    partId: part.id, 
                    partName: part.name,
                    lineName: lineName,
                    name: prosesName 
                });
                console.log("Proses successfully added!");
                showAlert('Sukses', `Proses ${prosesName} berhasil ditambahkan untuk part ${partName} di line ${lineName}!`);
                prosesLineSelect.value = '';
                prosesPartSelect.innerHTML = '<option value="">Pilih Part</option>';
                prosesNameInput.value = '';
                // Refresh master data
                await fetchMasterData();
                renderProsesList();
            } catch (error) {
                console.error("Error saving proses: ", error);
                showAlert('Error', 'Gagal menyimpan proses: ' + error.message);
            }
        });
        
        ngItemManagementForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const lineName = ngItemLineSelect.value;
            const partName = ngItemPartSelect.value;
            const prosesName = ngItemProsesSelect.value;
            const ngItemName = ngItemNameInput.value.trim();
            
            if (!lineName) {
                ngItemLineError.textContent = 'Pilih line produksi';
                ngItemLineError.classList.remove('d-none');
                return;
            }
            
            if (!partName) {
                ngItemPartError.textContent = 'Pilih part';
                ngItemPartError.classList.remove('d-none');
                return;
            }
            
            if (!prosesName) {
                ngItemProsesError.textContent = 'Pilih proses';
                ngItemProsesError.classList.remove('d-none');
                return;
            }
            
            if (!ngItemName) {
                ngItemNameError.textContent = 'Nama item NG tidak boleh kosong';
                ngItemNameError.classList.remove('d-none');
                return;
            }
            
            ngItemLineError.classList.add('d-none');
            ngItemPartError.classList.add('d-none');
            ngItemProsesError.classList.add('d-none');
            ngItemNameError.classList.add('d-none');
            
            // Check if NG item already exists for this line, part, and proses
            const ngItemExists = ngItemData.some(ngItem => 
                ngItem.lineName === lineName && 
                ngItem.partName === partName && 
                ngItem.prosesName === prosesName && 
                ngItem.name === ngItemName
            );
            if (ngItemExists) {
                ngItemNameError.textContent = 'Item NG dengan nama ini sudah ada untuk proses ini';
                ngItemNameError.classList.remove('d-none');
                return;
            }
            
            try {
                // Find prosesId
                const proses = prosesData.find(p => 
                    p.lineName === lineName && 
                    p.partName === partName && 
                    p.name === prosesName
                );
                if (!proses) {
                    ngItemProsesError.textContent = 'Proses tidak ditemukan';
                    ngItemProsesError.classList.remove('d-none');
                    return;
                }
                
                // Save to Firestore
                await addDoc(collection(db, "ngItems"), { 
                    prosesId: proses.id, 
                    prosesName: proses.name,
                    partName: partName,
                    lineName: lineName,
                    name: ngItemName 
                });
                console.log("NG Item successfully added!");
                showAlert('Sukses', `Item NG ${ngItemName} berhasil ditambahkan untuk proses ${prosesName}, part ${partName} di line ${lineName}!`);
                ngItemLineSelect.value = '';
                ngItemPartSelect.innerHTML = '<option value="">Pilih Part</option>';
                ngItemProsesSelect.innerHTML = '<option value="">Pilih Proses</option>';
                ngItemNameInput.value = '';
                // Refresh master data
                await fetchMasterData();
                renderNgItemList();
            } catch (error) {
                console.error("Error saving NG item: ", error);
                showAlert('Error', 'Gagal menyimpan item NG: ' + error.message);
            }
        });
        
        // Dynamic select population for management forms
        prosesLineSelect.addEventListener('change', () => {
            const lineName = prosesLineSelect.value;
            populatePartSelect(prosesPartSelect, lineName);
        });
        
        ngItemLineSelect.addEventListener('change', () => {
            const lineName = ngItemLineSelect.value;
            populatePartSelect(ngItemPartSelect, lineName);
        });
        
        ngItemPartSelect.addEventListener('change', () => {
            const lineName = ngItemLineSelect.value;
            const partName = ngItemPartSelect.value;
            populateProsesSelect(ngItemProsesSelect, lineName, partName);
        });
        // Filter event listeners
        filterLine.addEventListener('change', () => {
            updateFilterPartOptions();
            renderData(window.fullDataList || []);
        });
        filterPart.addEventListener('change', () => renderData(window.fullDataList || []));
        filterGroup.addEventListener('change', () => renderData(window.fullDataList || []));
        filterShift.addEventListener('change', () => renderData(window.fullDataList || []));
        resetFilterBtn.addEventListener('click', () => {
            filterLine.value = '';
            filterPart.innerHTML = '<option value="">Semua Part</option>';
            filterGroup.value = '';
            filterShift.value = '';
            renderData(window.fullDataList || []);
        });
        // Input form submission
        productionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // Cek hak akses input
            if (userPermissions && !userPermissions.canInput) {
                showAlert('Akses Ditolak', 'Anda tidak memiliki hak akses untuk input data.');
                return;
            }
            setInputLoading(true);
            showInputStatus('', false);
            // Get form data
            const data = {
                namaLineProduksi: lineSelect.value,
                namaPart: partSelect.value,
                tanggal: document.getElementById('tanggal').value,
                group: document.getElementById('group').value,
                shift: shiftSelect.value,
                sigmaProduksi: parseFloat(document.getElementById('sigmaProduksi').value),
                sigmaOP: parseFloat(document.getElementById('sigmaOP').value),
                loadingTime: parseFloat(document.getElementById('loadingTime').value),
                timestamp: new Date()
            };
            // Cek apakah user memiliki akses ke line produksi ini
            if (userPermissions.accessibleLines && 
                !userPermissions.accessibleLines.includes(data.namaLineProduksi)) {
                showAlert('Akses Ditolak', 'Anda tidak memiliki hak akses untuk input data line produksi ini.');
                setInputLoading(false);
                return;
            }
            try {
                if (documentIdInput.value) {
                    // Update existing document
                    const docRef = doc(db, "produksiData", documentIdInput.value);
                    await updateDoc(docRef, data);
                    console.log("Document successfully updated!");
                    showAlert('Sukses', 'Data berhasil diperbarui!', () => {
                        showPage('homePage');
                        fetchData();
                    });
                } else {
                    // Add new document
                    const docRef = await addDoc(collection(db, "produksiData"), data);
                    console.log("Document written with ID: ", docRef.id);
                    showAlert('Sukses', 'Data berhasil disimpan!', () => {
                        showPage('homePage');
                        fetchData();
                    });
                }
                resetForm();
            } catch (error) {
                console.error("Error saving document: ", error);
                showAlert('Error', 'Gagal menyimpan data: ' + error.message);
            } finally {
                setInputLoading(false);
            }
        });
        // KPP Form Submission
        kppForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // Cek hak akses input
            if (userPermissions && !userPermissions.canInput) {
                showAlert('Akses Ditolak', 'Anda tidak memiliki hak akses untuk input data KPP.');
                return;
            }
            setKppInputLoading(true);
            showKppStatus('', false);

            // Get form data
            const kppData = {
                namaLineProduksi: kppLineSelect.value,
                namaPart: kppPartSelect.value,
                proses: kppProsesSelect.value,
                itemNG: kppItemNgSelect.value,
                tanggal: document.getElementById('kppTanggal').value,
                shift: document.getElementById('kppShift').value,
                jumlahNG: parseInt(document.getElementById('kppJumlah').value, 10) || 0,
                keterangan: document.getElementById('kppKeterangan').value,
                timestamp: new Date()
            };

            // Validasi data dasar
            if (!kppData.namaLineProduksi || !kppData.namaPart || !kppData.proses || !kppData.itemNG || !kppData.tanggal || !kppData.shift || isNaN(kppData.jumlahNG)) {
                 showKppStatus('Harap lengkapi semua field yang wajib diisi.', true);
                 setKppInputLoading(false);
                 return;
            }

            // Cek apakah user memiliki akses ke line produksi ini
            if (userPermissions.accessibleLines &&
                !userPermissions.accessibleLines.includes(kppData.namaLineProduksi)) {
                showAlert('Akses Ditolak', 'Anda tidak memiliki hak akses untuk input data KPP line produksi ini.');
                setKppInputLoading(false);
                return;
            }

            try {
                if (kppDocumentIdInput.value) {
                    // Update existing document (jika fitur edit KPP diimplementasikan)
                    // const docRef = doc(db, "kppData", kppDocumentIdInput.value);
                    // await updateDoc(docRef, kppData);
                    // console.log("KPP Document successfully updated!");
                    // showAlert('Sukses', 'Data KPP berhasil diperbarui!', () => {
                    //     showPage('homePage'); // Atau halaman list KPP jika ada
                    //     // fetchDataKpp(); // Refresh data KPP jika ada
                    // });
                } else {
                    // Add new document
                    const docRef = await addDoc(collection(db, "kppData"), kppData);
                    console.log("KPP Document written with ID: ", docRef.id);
                    showAlert('Sukses', 'Data KPP berhasil disimpan!', () => {
                         // Opsional: Arahkan ke halaman tertentu setelah sukses
                         // showPage('homePage');
                    });
                }
                resetKppForm();
            } catch (error) {
                console.error("Error saving KPP document: ", error);
                showAlert('Error', 'Gagal menyimpan data KPP: ' + error.message);
            } finally {
                setKppInputLoading(false);
            }
        });
        // Delete confirmation
        confirmDeleteBtn.addEventListener('click', deleteData);
        // Initialize
        updateMonthDisplay();
        formatDateRange();
        loadSettings();
        updateFilterPartOptions();
    </script>
    <!-- Bootstrap JS (needed for modal) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
